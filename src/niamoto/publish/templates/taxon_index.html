{% extends '_base.html' %}

{% block title %}Niamoto - Liste des Arbres{% endblock %}

{% block extra_head %}
<style>
    .search-container {
        position: relative;
        margin-bottom: 2rem;
    }

    #searchInput {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 1rem;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #718096;
    }

    .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #4a5568;
    }

    .filter-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .pagination button {
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.25rem;
        background-color: #f7fafc;
        cursor: pointer;
    }

    .pagination button.active {
        background-color: #57a353;
        color: white;
        border-color: #57a353;
    }

    .pagination button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    /* Structure de base des cartes */
.taxon-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.taxon-card {
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: transform 0.2s, box-shadow 0.2s;
    background-color: white;
}

.taxon-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* Conteneur flexible pour l'image et les informations */
.taxon-card-content {
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* Images */
.taxon-card-image-container {
    width: 100%;
    height: 200px;
}

.taxon-card-image {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.taxon-card-image-placeholder {
    width: 100%;
    height: 100%;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Informations du taxon */
.taxon-card-info {
    padding: 1rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.taxon-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
}

.taxon-name a {
    color: inherit;
    text-decoration: none;
}

.taxon-name a:hover {
    text-decoration: underline;
}

.endemic-badge {
    display: inline-block;
    background-color: #57a353;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
    vertical-align: middle;
}

.taxon-details {
    flex-grow: 1;
}

.taxon-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px dashed #e2e8f0;
}

.taxon-info-label {
    color: #718096;
    font-weight: 500;
}

.taxon-info-value {
    text-align: right;
    font-weight: 500;
}

.taxon-extra-links {
    margin-top: 1rem;
    text-align: right;
    font-size: 0.9em;
}

.endemia-link {
    display: inline-block;
    background-color: #f7efe7;
    color: #7bb348;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    text-decoration: none;
    font-weight: 500;
    transition: background-color 0.2s;
}

.endemia-link:hover {
    background-color: #f7f7f7;
}

/* Version responsive pour grands écrans */
@media (min-width: 768px) {
    .taxon-card-content {
        flex-direction: row;
    }

    .taxon-card-image-container {
        width: 40%;
        height: auto;
    }

    .taxon-card-info {
        width: 60%;
    }
}

    .no-results {
        text-align: center;
        padding: 3rem;
        color: #718096;
        font-style: italic;
    }

    .stats-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        color: #4a5568;
    }

    .view-toggles {
        display: flex;
        gap: 0.5rem;
    }

    .view-toggle {
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.25rem;
        background-color: #f7fafc;
        cursor: pointer;
    }

    .view-toggle.active {
        background-color: #57a353;
        color: white;
    }

    .taxon-list-view {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .taxon-extra-links {
        margin-top: auto;
        padding-top: 0.5rem;
    }
    .taxon-extra-links img {
        width: 42px;
    }

    .taxon-extra-link {
        display: inline-block;
        margin-right: 0.5rem;
        color: #57a353;
        text-decoration: none;
        font-size: 0.875rem;
    }

    .taxon-extra-link:hover {
        text-decoration: underline;
    }

    @media (max-width: 768px) {
        .filters-container {
            flex-direction: column;
        }

        .filter-group {
            min-width: 100%;
        }

        .taxon-list {
            grid-template-columns: 1fr;
        }
    }

    /* Ajout de style pour le badge UICN */
    .uicn-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        vertical-align: middle;
        color: white;
    }

    .uicn-badge.CR {
        background-color: #d32f2f;
    }

    .uicn-badge.EN {
        background-color: #f57c00;
    }

    .uicn-badge.VU {
        background-color: #fbc02d;
        color: black;
    }

    .uicn-badge.NT {
        background-color: #2e7d32;
    }

    .uicn-badge.LC {
        background-color: #388e3c;
    }

    .uicn-badge.DD {
        background-color: #757575;
    }

    .uicn-badge.NE {
        background-color: #bdbdbd;
        color: black;
    }

    /* Style pour les boutons de liens externes */
    .external-link-button {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        border-radius: 0.25rem;
        text-decoration: none;
        font-weight: 500;
        transition: background-color 0.2s;
        margin-right: 0.5rem;
    }

    .endemia-link {
        background-color: #f7efe7;
        color: #7bb348;
    }

    .florical-link {
        background-color: #e7f7ef;
        color: #2c7a7b;
    }

    .external-link-button:hover {
        filter: brightness(0.95);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 mt-16">
    <h1 class="text-3xl font-bold mb-6">Arbres</h1>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Rechercher un taxon..." aria-label="Rechercher un taxon">
        <svg class="search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    </div>

    <div class="filters-container">
        <div class="filter-group">
            <label for="rankFilter" class="filter-label">Rang taxonomique</label>
            <select id="rankFilter" class="filter-select">
                <option value="all">Tous les rangs</option>
                <option value="species">Espèce</option>
                <option value="infra">Sous-espèce</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="familyFilter" class="filter-label">Famille</label>
            <select id="familyFilter" class="filter-select">
                <option value="all">Toutes les familles</option>
                <!-- Sera rempli dynamiquement -->
            </select>
        </div>

        <div class="filter-group">
            <label for="endemicFilter" class="filter-label">Endémisme</label>
            <select id="endemicFilter" class="filter-select">
                <option value="all">Tous</option>
                <option value="true">Endémiques</option>
                <option value="false">Non endémiques</option>
            </select>
        </div>

        <!-- Nouveau filtre pour les catégories UICN -->
        <div class="filter-group">
            <label for="uicnFilter" class="filter-label">Catégorie UICN</label>
            <select id="uicnFilter" class="filter-select">
                <option value="all">Toutes les catégories</option>
                <option value="CR">En danger critique (CR)</option>
                <option value="EN">En danger (EN)</option>
                <option value="VU">Vulnérable (VU)</option>
                <option value="NT">Quasi menacé (NT)</option>
                <option value="LC">Préoccupation mineure (LC)</option>
                <option value="DD">Données insuffisantes (DD)</option>
                <option value="NE">Non évalué (NE)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sortBy" class="filter-label">Trier par</label>
            <select id="sortBy" class="filter-select">
                <option value="name">Nom scientifique</option>
                <option value="occurrences">Nombre d'occurrences</option>
                <option value="family">Famille</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sortOrder" class="filter-label">Ordre</label>
            <select id="sortOrder" class="filter-select">
                <option value="asc">Croissant</option>
                <option value="desc">Décroissant</option>
            </select>
        </div>
    </div>

    <div class="stats-bar">
        <div id="resultCount">Affichage de 0 taxons sur {{ taxa_data|length }}</div>

        <div class="view-toggles">
            <button id="gridViewBtn" class="view-toggle active" title="Vue en grille">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z" />
                </svg>
            </button>
            <button id="listViewBtn" class="view-toggle" title="Vue en liste">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z" />
                    <path
                        d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z" />
                    <path fill-rule="evenodd"
                        d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5V7zM2 7h1v1H2V7zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2zm1 .5H2v1h1v-1z" />
                </svg>
            </button>
        </div>
    </div>

    <div class="taxon-list" id="taxonList">
        <!-- Les taxons seront injectés ici via JavaScript -->
    </div>

    <div class="pagination" id="pagination">
        <!-- Les boutons de pagination seront injectés ici via JavaScript -->
    </div>

    <div class="no-results hidden" id="noResults">
        <p>Aucun taxon trouvé pour cette recherche.</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Données des taxons
    const allTaxa = {{ taxa_data| tojson | safe }};

    // Configuration
    const itemsPerPage = 24;
    let currentPage = 1;
    let filteredTaxa = [...allTaxa];
    let currentView = 'grid'; // 'grid' ou 'list'

    // Éléments DOM
    const taxonListElement = document.getElementById('taxonList');
    const paginationElement = document.getElementById('pagination');
    const searchInput = document.getElementById('searchInput');
    const rankFilter = document.getElementById('rankFilter');
    const familyFilter = document.getElementById('familyFilter');
    const endemicFilter = document.getElementById('endemicFilter');
    const uicnFilter = document.getElementById('uicnFilter'); // Nouveau filtre UICN
    const sortBySelect = document.getElementById('sortBy');
    const sortOrderSelect = document.getElementById('sortOrder');
    const noResultsElement = document.getElementById('noResults');
    const resultCountElement = document.getElementById('resultCount');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');

    // Initialisation
    document.addEventListener('DOMContentLoaded', function () {
        // Remplir le filtre des familles
        populateFamilyFilter();

        // Premier rendu
        applyFiltersAndSort();

        // Event listeners
        searchInput.addEventListener('input', applyFiltersAndSort);
        rankFilter.addEventListener('change', applyFiltersAndSort);
        familyFilter.addEventListener('change', applyFiltersAndSort);
        endemicFilter.addEventListener('change', applyFiltersAndSort);
        uicnFilter.addEventListener('change', applyFiltersAndSort); // Nouveau listener pour UICN
        sortBySelect.addEventListener('change', applyFiltersAndSort);
        sortOrderSelect.addEventListener('change', applyFiltersAndSort);

        // Toggle vue grille/liste
        gridViewBtn.addEventListener('click', function () {
            setView('grid');
        });

        listViewBtn.addEventListener('click', function () {
            setView('list');
        });

        // Restaurer les préférences utilisateur si disponibles
        const savedView = localStorage.getItem('taxonViewPreference');
        if (savedView) {
            setView(savedView);
        }
    });

    // Remplir le filtre des familles
    function populateFamilyFilter() {
        const families = [...new Set(allTaxa
            .filter(taxon => taxon.parent_family)
            .map(taxon => taxon.parent_family))]
            .sort();

        families.forEach(family => {
            const option = document.createElement('option');
            option.value = family;
            option.textContent = family;
            familyFilter.appendChild(option);
        });
    }

    // Définir le mode d'affichage (grille ou liste)
    function setView(viewType) {
        currentView = viewType;

        // Mettre à jour les boutons
        if (viewType === 'grid') {
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            taxonListElement.classList.add('taxon-list');
            taxonListElement.classList.remove('taxon-list-view');
        } else {
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
            taxonListElement.classList.remove('taxon-list');
            taxonListElement.classList.add('taxon-list-view');
        }

        // Sauvegarder la préférence
        localStorage.setItem('taxonViewPreference', viewType);

        // Re-render avec la nouvelle vue
        renderTaxonList();
    }

    // Convertir la valeur d'endémisme en booléen pour la comparaison
    function parseEndemic(value) {
        if (typeof value === 'string') {
            return value.toLowerCase() === 'true';
        }
        return Boolean(value);
    }

    // Appliquer les filtres et le tri
    function applyFiltersAndSort() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedRank = rankFilter.value;
        const selectedFamily = familyFilter.value;
        const selectedEndemic = endemicFilter.value;
        const selectedUicn = uicnFilter.value; // Nouvelle valeur de filtre UICN
        const sortBy = sortBySelect.value;
        const sortOrder = sortOrderSelect.value;

        // Filtrer
        filteredTaxa = allTaxa.filter(taxon => {
            // Filtre de recherche
            const matchesSearch = taxon.name.toLowerCase().includes(searchTerm);

            // Filtre de rang taxonomique
            const matchesRank = selectedRank === 'all' ||
                (taxon.rank && taxon.rank.toLowerCase() === selectedRank.toLowerCase());

            // Filtre de famille
            const matchesFamily = selectedFamily === 'all' ||
                (taxon.parent_family && taxon.parent_family === selectedFamily);

            // Filtre d'endémisme
            const matchesEndemic = selectedEndemic === 'all' ||
                (taxon.endemic !== undefined &&
                    parseEndemic(taxon.endemic) === (selectedEndemic === 'true'));

            // Filtre UICN
            const matchesUicn = selectedUicn === 'all' ||
                (taxon.redlist_cat && taxon.redlist_cat === selectedUicn);

            return matchesSearch && matchesRank && matchesFamily && matchesEndemic && matchesUicn;
        });

        // Trier
        filteredTaxa.sort((a, b) => {
            let comparison = 0;

            if (sortBy === 'name') {
                comparison = a.name.localeCompare(b.name);
            } else if (sortBy === 'occurrences') {
                const occA = a.occurrences_count || 0;
                const occB = b.occurrences_count || 0;
                comparison = occA - occB;
            } else if (sortBy === 'family') {
                const famA = a.parent_family || '';
                const famB = b.parent_family || '';
                comparison = famA.localeCompare(famB);
            }

            // Inverser si l'ordre est décroissant
            return sortOrder === 'desc' ? -comparison : comparison;
        });

        // Réinitialiser la pagination
        currentPage = 1;

        // Afficher
        renderTaxonList();
    }

    // Obtenir l'URL de l'image si disponible
    function getImageUrl(taxon) {
        if (taxon.image_url) return taxon.image_url;

        if (taxon.images && Array.isArray(taxon.images) && taxon.images.length > 0) {
            // Récupérer la première image
            return taxon.images[0].small_thumb || taxon.images[0].url;
        }

        return null;
    }

    // Rendu de la liste des taxons
    function renderTaxonList() {
        // Afficher le message "pas de résultats" si nécessaire
        if (filteredTaxa.length === 0) {
            taxonListElement.innerHTML = '';
            paginationElement.innerHTML = '';
            noResultsElement.classList.remove('hidden');
            resultCountElement.textContent = 'Aucun taxon trouvé';
            return;
        }

        noResultsElement.classList.add('hidden');

        // Calculer les indices de début et de fin pour la pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredTaxa.length);
        const currentTaxa = filteredTaxa.slice(startIndex, endIndex);

        // Mettre à jour le compteur de résultats
        resultCountElement.textContent = `Affichage de ${startIndex + 1}-${endIndex} sur ${filteredTaxa.length} taxons`;

        // Générer le HTML en fonction de la vue
        if (currentView === 'grid') {
            renderGridView(currentTaxa);
        } else {
            renderListView(currentTaxa);
        }

        // Générer la pagination
        renderPagination();
    }

    // Rendu en mode grille
    function renderGridView(taxa) {
            taxonListElement.className = "taxon-list";
            taxonListElement.innerHTML = taxa.map(taxon => {
                const imageUrl = getImageUrl(taxon);
                const isEndemic = parseEndemic(taxon.endemic);
                const uicnCategory = taxon.redlist_cat || 'NE';
                const florical_url = taxon.id_florical ?
                    `http://publish.plantnet-project.org/project/florical_fr/collection/florical/taxons/details/${taxon.id_florical}` : null;

                return `
        <div class="taxon-card">
            <div class="taxon-card-content">
                <!-- Image à gauche pour desktop, en haut pour mobile -->
                <div class="taxon-card-image-container">
                    ${imageUrl ?
                        `<div class="taxon-card-image" style="background-image: url('${imageUrl}')"></div>` :
                        '<div class="taxon-card-image-placeholder"></div>'}
                </div>

                <!-- Informations à droite pour desktop, en bas pour mobile -->
                <div class="taxon-card-info">
                    <h3 class="taxon-name">
                        <a href="{{ depth }}taxon/${taxon.id}.html">${taxon.name}</a><br>
                        ${isEndemic ? '<span class="endemic-badge">Endémique</span>' : ''}
                        ${taxon.redlist_cat && uicnCategory ? `<span class="uicn-badge ${uicnCategory}" title="${translateUICN(uicnCategory)}">${uicnCategory}</span>` : ''}
                    </h3>

                    <div class="taxon-details">
                        <div class="taxon-info">
                            <span class="taxon-info-label">Famille:</span>
                            <span class="taxon-info-value">${taxon.parent_family || 'Non spécifiée'}</span>
                        </div>
                        <div class="taxon-info">
                            <span class="taxon-info-label">Genre:</span>
                            <span class="taxon-info-value">${taxon.parent_genus || 'Non spécifié'}</span>
                        </div>
                        <div class="taxon-info">
                            <span class="taxon-info-label">Rang:</span>
                            <span class="taxon-info-value">${translateRank(taxon.rank)}</span>
                        </div>
                        <div class="taxon-info">
                            <span class="taxon-info-label">Occurrences:</span>
                            <span class="taxon-info-value">${taxon.occurrences_count || 0}</span>
                        </div>
                    </div>

                    <div class="taxon-extra-links">
                        ${taxon.endemia_url ? `
                        <a href="${taxon.endemia_url}" target="_blank" class="external-link-button endemia-link" title="Voir sur Endemia">
                            Endemia
                        </a>
                        ` : ''}
                        ${florical_url ? `
                        <a href="${florical_url}" target="_blank" class="external-link-button florical-link" title="Voir sur Florical">
                            Florical
                        </a>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        `;
            }).join('');
    }

    // Rendu en mode liste
    function renderListView(taxa) {
        taxonListElement.className = "space-y-2";
        taxonListElement.innerHTML = taxa.map(taxon => {
            const isEndemic = parseEndemic(taxon.endemic);
            const uicnCategory = taxon.redlist_cat || 'NE';
            const florical_url = taxon.id_florical ?
                `http://publish.plantnet-project.org/project/florical_fr/collection/florical/taxons/details/${taxon.id_florical}` : null;

            return `
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center">
                    <div class="mb-2 md:mb-0">
                        <a href="taxon/${taxon.id}.html" class="text-green-600 hover:text-green-800 font-semibold">
                            ${taxon.name}
                        </a>
                        ${isEndemic ? '<span class="endemic-badge">Endémique</span>' : ''}
                        ${taxon.redlist_cat && uicnCategory ? `<span class="uicn-badge ${uicnCategory}" title="${translateUICN(uicnCategory)}">${uicnCategory}</span>` : ''} |
                        <span class="text-gray-500 text-sm ml-2">${translateRank(taxon.rank)}</span> |
                        ${taxon.parent_family ?
                    `<span class="text-gray-500 text-sm ml-2">Famille: ${taxon.parent_family}</span>` : ''} |
                    ${taxon.parent_genus ?
                    `<span class="text-gray-500 text-sm ml-2">Genre: ${taxon.parent_genus}</span>` : ''}
                    </div>
                    <div class="flex items-center">
                        ${taxon.occurrences_count ? `
                        <div class="text-gray-700 mr-4">
                            <span class="font-medium">${taxon.occurrences_count}</span> occurrences
                        </div>
                        ` : ''}
                        ${taxon.endemia_url ? `
                        <a href="${taxon.endemia_url}" target="_blank" class="external-link-button endemia-link mr-2" title="Voir sur Endemia">
                            Endemia
                        </a>
                        ` : ''}
                        ${florical_url ? `
                        <a href="${florical_url}" target="_blank" class="external-link-button florical-link" title="Voir sur Florical">
                            Florical
                        </a>
                        ` : ''}
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // Rendu de la pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredTaxa.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationElement.innerHTML = '';
            return;
        }

        let paginationHTML = `
            <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>
                &laquo; Premier
            </button>
            <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                &lsaquo; Précédent
            </button>
        `;

        // Afficher un nombre limité de pages
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">
                    ${i}
                </button>
            `;
        }

        paginationHTML += `
            <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                Suivant &rsaquo;
            </button>
            <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                Dernier &raquo;
            </button>
        `;

        paginationElement.innerHTML = paginationHTML;
    }

    // Fonction pour traduire le code UICN en texte
    function translateUICN(code) {
        const translations = {
            'CR': 'En danger critique',
            'EN': 'En danger',
            'VU': 'Vulnérable',
            'NT': 'Quasi menacé',
            'LC': 'Préoccupation mineure',
            'DD': 'Données insuffisantes',
            'NE': 'Non évalué'
        };
        return translations[code] || code;
    }

    function translateRank(rank) {
            if (!rank) return 'Non spécifié';

            const translations = {
                'species': 'Espèce',
                'infra': 'Sous-espèce',
                // Vous pouvez ajouter d'autres traductions si nécessaire
                'genus': 'Genre',
                'family': 'Famille'
            };

            return translations[rank.toLowerCase()] || rank;
        }

    // Navigation entre les pages
    function goToPage(page) {
        currentPage = page;
        renderTaxonList();
        // Scroll vers le haut de la liste
        window.scrollTo({ top: taxonListElement.offsetTop - 100, behavior: 'smooth' });
    }
</script>
{% endblock %}
