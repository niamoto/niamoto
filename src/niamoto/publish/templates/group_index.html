{% extends '_base.html' %}

{% block title %}{{ page_config.title | default('Index') }} - {{ site.title | default('Niamoto') }}{% endblock %}

{% block styles %}
<style>
    .endemic-badge {
        background-color: #10b981;
        color: white;
    }

    /* Styles pour les cartes avec images */
    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .item-card {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.2s, box-shadow 0.2s;
        background-color: white;
    }

    .item-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Conteneur flexible pour l'image et les informations */
    .item-card-content {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    /* Images */
    .item-card-image-container {
        width: 100%;
        height: 200px;
    }

    .item-card-image {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    .item-card-image-placeholder {
        width: 100%;
        height: 100%;
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 0.875rem;
    }

    /* Informations de l'élément */
    .item-card-info {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .item-name {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .item-name a {
        color: inherit;
        text-decoration: none;
    }

    .item-name a:hover {
        text-decoration: underline;
    }

    .item-details {
        flex-grow: 1;
    }

    .item-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px dashed #e2e8f0;
    }

    .item-info-label {
        color: #718096;
        font-weight: 500;
    }

    .item-info-value {
        text-align: right;
        font-weight: 500;
    }

    /* Version responsive pour grands écrans */
    @media (min-width: 768px) {
        .item-card-content {
            flex-direction: row;
        }

        .item-card-image-container {
            width: 40%;
            height: auto;
        }

        .item-card-info {
            width: 60%;
        }
    }

    /* Liste responsive */
    @media (max-width: 768px) {
        .items-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Styles génériques pour les badges */
    .field-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        vertical-align: middle;
    }

    /* Liste simple */
    .items-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Liens externes */
    .item-external-links {
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px solid #e2e8f0;
        text-align: right;
    }

    .external-link {
        display: inline-block;
        margin-left: 0.5rem;
        padding: 0.25rem 0.75rem;
        background-color: #f3f4f6;
        color: #374151;
        text-decoration: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: background-color 0.2s;
    }

    .external-link:hover {
        background-color: #e5e7eb;
        color: #1f2937;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">{{ page_config.title | default(group_by | title) }}</h1>

    <!-- Recherche -->
    <div class="relative mb-8">
        <input type="text" id="searchInput"
               placeholder="Rechercher..."
               aria-label="Rechercher"
               class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary text-sm">
        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    </div>

    <!-- Filtres dynamiques -->
    <div class="flex flex-wrap gap-4 mb-8" id="filtersContainer">
        <!-- Les filtres seront générés dynamiquement par JavaScript -->
    </div>

    <!-- Barre de stats et toggle de vue -->
    <div class="flex justify-between items-center mb-6">
        <div id="resultCount" class="text-sm text-gray-600">Chargement...</div>
        <div class="flex gap-2">
            <button id="gridViewBtn"
                    class="p-2 border border-gray-300 rounded-md bg-green-600 text-white hover:bg-green-700 focus:ring-2 focus:ring-primary"
                    title="Vue en grille">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z">
                    </path>
                </svg>
            </button>
            <button id="listViewBtn"
                    class="p-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 focus:ring-2 focus:ring-primary"
                    title="Vue en liste">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z"></path>
                    <path
                        d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z">
                    </path>
                    <path fill-rule="evenodd"
                        d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5V7zM2 7h1v1H2V7zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2zm1 .5H2v1h1v-1z">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Conteneur des éléments -->
    <div class="items-grid" id="itemsContainer">
        <!-- Les éléments seront injectés ici par JavaScript -->
    </div>

    <!-- Pagination -->
    <div class="flex justify-center mt-8" id="pagination">
        <!-- Les boutons de pagination seront injectés ici -->
    </div>

    <!-- Message aucun résultat -->
    <div class="text-center py-12 text-gray-500 italic hidden" id="noResults">
        <p>Aucun élément trouvé pour cette recherche.</p>
    </div>
</div>

<!-- Modal pour afficher une image en grand -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4">
    <div class="relative w-full h-full max-w-5xl max-h-full flex items-center justify-center mt-20">
        <!-- Bouton fermer -->
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-3xl leading-none z-10 bg-black bg-opacity-50 rounded-full w-12 h-12 flex items-center justify-center">
            ×
        </button>

        <!-- Flèche précédente -->
        <button id="prevImageBtn" onclick="previousImage()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 text-4xl z-10 bg-black bg-opacity-50 rounded-full w-12 h-12 flex items-center justify-center hidden">
            ‹
        </button>

        <!-- Conteneur central pour loader et image -->
        <div class="flex items-center justify-center w-full h-full min-h-96">
            <!-- Loader -->
            <div id="imageLoader" class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white"></div>
            </div>

            <!-- Image en grand -->
            <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain hidden">
        </div>

        <!-- Flèche suivante -->
        <button id="nextImageBtn" onclick="nextImage()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 text-4xl z-10 bg-black bg-opacity-50 rounded-full w-12 h-12 flex items-center justify-center hidden">
            ›
        </button>

        <!-- Indicateur de position -->
        <div id="imageCounter" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-white bg-black bg-opacity-50 px-3 py-1 rounded hidden">
            <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Configuration et données injectées par le plugin
    const indexConfig = {{ index_config | tojson | safe }};
    const itemsData = {{ items_data | tojson | safe }};
    const pageDepth = {{ depth | default(0) }};

    // Variables globales
    let currentPage = 1;
    let filteredItems = [...itemsData];
    let currentView = 'grid';
    const itemsPerPage = indexConfig.page_config.items_per_page || 20;

    // Fonction pour créer des URLs relatives
    function makeRelativeUrl(url) {
        if (!url || typeof url !== 'string') return url;

        // Keep absolute URLs and anchors as is
        if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('#') ||
            url.startsWith('mailto:') || url.startsWith('javascript:')) {
            return url;
        }

        // Handle root-relative URLs
        if (url.startsWith('/')) {
            // Convert to relative based on depth
            if (pageDepth === 0) {
                return url.substr(1);  // Remove leading slash for root level
            } else {
                return '../'.repeat(pageDepth) + url.substr(1);
            }
        }

        // Already relative URL
        return url;
    }

    // Éléments DOM
    const searchInput = document.getElementById('searchInput');
    const filtersContainer = document.getElementById('filtersContainer');
    const itemsContainer = document.getElementById('itemsContainer');
    const paginationElement = document.getElementById('pagination');
    const resultCountElement = document.getElementById('resultCount');
    const noResultsElement = document.getElementById('noResults');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        generateFilters();
        setupEventListeners();
        applyFiltersAndSort();

        // Restaurer la vue sauvegardée ou initialiser par défaut
        const savedView = localStorage.getItem(`${indexConfig.group_by}ViewPreference`);
        if (savedView) {
            setView(savedView);
        } else {
            setView('grid'); // Vue par défaut
        }
    });

    // Génération dynamique des filtres
    function generateFilters() {
        const filtersHTML = indexConfig.display_fields
            .filter(field => field.type === 'select' || field.type === 'boolean')
            .map(field => {
                if (field.type === 'boolean') {
                    return `
                        <div class="flex-1 min-w-48">
                            <label for="${field.name}Filter" class="block text-sm font-medium text-gray-700 mb-2">${field.label || field.name}</label>
                            <select id="${field.name}Filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                                <option value="all">Tous</option>
                                <option value="true">Oui</option>
                                <option value="false">Non</option>
                            </select>
                        </div>
                    `;
                } else if (field.dynamic_options) {
                    // Générer les options depuis les données
                    const uniqueValues = [...new Set(itemsData
                        .map(item => getFieldValue(item, field))
                        .filter(value => value)
                    )].sort();

                    const optionsHTML = uniqueValues.map(value =>
                        `<option value="${value}">${value}</option>`
                    ).join('');

                    return `
                        <div class="flex-1 min-w-48">
                            <label for="${field.name}Filter" class="block text-sm font-medium text-gray-700 mb-2">${field.label || field.name}</label>
                            <select id="${field.name}Filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                                <option value="all">Tous</option>
                                ${optionsHTML}
                            </select>
                        </div>
                    `;
                } else if (field.filter_options) {
                    const optionsHTML = field.filter_options.map(option =>
                        `<option value="${option.value}">${option.label}</option>`
                    ).join('');

                    return `
                        <div class="flex-1 min-w-48">
                            <label for="${field.name}Filter" class="block text-sm font-medium text-gray-700 mb-2">${field.label || field.name}</label>
                            <select id="${field.name}Filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                                <option value="all">Tous</option>
                                ${optionsHTML}
                            </select>
                        </div>
                    `;
                }
                return '';
            }).join('');

        // Ajouter les contrôles de tri
        const sortHTML = `
            <div class="flex-1 min-w-48">
                <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-2">Trier par</label>
                <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                    ${indexConfig.display_fields.map(field =>
                        `<option value="${field.name}">${field.label || field.name}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="flex-1 min-w-48">
                <label for="sortOrder" class="block text-sm font-medium text-gray-700 mb-2">Ordre</label>
                <select id="sortOrder" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                    <option value="asc">Croissant</option>
                    <option value="desc">Décroissant</option>
                </select>
            </div>
        `;

        filtersContainer.innerHTML = filtersHTML + sortHTML;
    }

    // Configuration des event listeners
    function setupEventListeners() {
        searchInput.addEventListener('input', applyFiltersAndSort);

        // Event listeners pour tous les filtres
        filtersContainer.addEventListener('change', applyFiltersAndSort);

        gridViewBtn.addEventListener('click', () => setView('grid'));
        listViewBtn.addEventListener('click', () => setView('list'));
    }

    // Extraction de valeur de champ avec chemins complexes
    function getFieldValue(item, field) {
        if (!field || !field.name) {
            return null;
        }

        // Les données sont déjà extraites par le backend et stockées directement sous field.name
        let value = item[field.name];

        // Si pas de valeur et qu'on a un fallback, essayer le fallback
        if ((value === undefined || value === null) && field.fallback) {
            value = item[field.fallback];
        }

        return value;
    }

    // Application des filtres et tri
    function applyFiltersAndSort() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        // Récupérer les valeurs de tous les filtres
        const filterValues = {};
        indexConfig.display_fields.forEach(field => {
            if (field.type === 'select' || field.type === 'boolean') {
                const filterElement = document.getElementById(`${field.name}Filter`);
                if (filterElement) {
                    filterValues[field.name] = filterElement.value;
                }
            }
        });

        const sortBy = document.getElementById('sortBy')?.value || 'name';
        const sortOrder = document.getElementById('sortOrder')?.value || 'asc';

        // Filtrer les éléments
        filteredItems = itemsData.filter(item => {
            // Filtre de recherche
            const searchableFields = indexConfig.display_fields
                .filter(field => field.searchable)
                .map(field => getFieldValue(item, field))
                .filter(value => value)
                .join(' ')
                .toLowerCase();

            const matchesSearch = !searchTerm || searchableFields.includes(searchTerm);

            // Filtres spécifiques
            const matchesFilters = Object.entries(filterValues).every(([fieldName, filterValue]) => {
                if (filterValue === 'all') return true;

                const field = indexConfig.display_fields.find(f => f.name === fieldName);
                let itemValue = getFieldValue(item, field);

                if (field.type === 'boolean') {
                    // Convert string boolean values to actual booleans for comparison
                    if (typeof itemValue === 'string') {
                        itemValue = itemValue.toLowerCase() === 'true';
                    }
                    return String(itemValue) === filterValue;
                } else {
                    return itemValue === filterValue;
                }
            });

            return matchesSearch && matchesFilters;
        });

        // Trier
        const sortField = indexConfig.display_fields.find(f => f.name === sortBy);
        if (sortField) {
            filteredItems.sort((a, b) => {
                const valueA = getFieldValue(a, sortField);
                const valueB = getFieldValue(b, sortField);

                let comparison = 0;
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    comparison = valueA.localeCompare(valueB);
                } else {
                    comparison = (valueA || 0) - (valueB || 0);
                }

                return sortOrder === 'desc' ? -comparison : comparison;
            });
        }

        currentPage = 1;
        renderItems();
    }

    // Rendu des éléments
    function renderItems() {
        if (filteredItems.length === 0) {
            itemsContainer.innerHTML = '';
            paginationElement.innerHTML = '';
            noResultsElement.classList.remove('hidden');
            resultCountElement.textContent = 'Aucun élément trouvé';
            return;
        }

        noResultsElement.classList.add('hidden');

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
        const currentItems = filteredItems.slice(startIndex, endIndex);

        resultCountElement.textContent = `Affichage de ${startIndex + 1}-${endIndex} sur ${filteredItems.length} éléments`;

        if (currentView === 'grid') {
            renderGridView(currentItems);
        } else {
            renderListView(currentItems);
        }

        renderPagination();
    }

    // Vue grille générique
    function renderGridView(items) {
        itemsContainer.className = "items-grid";

        // Reset styles
        itemsContainer.style.display = '';
        itemsContainer.style.gridTemplateColumns = '';
        itemsContainer.style.gap = '';
        itemsContainer.style.flexDirection = '';

        itemsContainer.innerHTML = items.map(item => {
            const imageField = indexConfig.display_fields.find(f => f.display === 'image_preview' || f.type === 'json_array');
            const imageUrl = getImageUrl(item, imageField);
            const nameField = indexConfig.display_fields.find(f => f.name === 'name');
            const itemName = getFieldValue(item, nameField) || item[indexConfig.id_column];

            // Ne pas afficher la section image si aucun champ d'image n'est configuré
            const hasImageField = imageField !== undefined;

            return `
            <div class="item-card">
                <div class="item-card-content">
                    ${hasImageField ? `
                    <!-- Image à gauche pour desktop, en haut pour mobile -->
                    <div class="item-card-image-container">
                        ${imageUrl ?
                            `<div class="item-card-image" style="background-image: url('${imageUrl}')"></div>` :
                            '<div class="item-card-image-placeholder">Aucune image</div>'
                        }
                    </div>
                    ` : ''}

                    <!-- Informations à droite pour desktop, en bas pour mobile -->
                    <div class="item-card-info">
                        <h3 class="item-name">
                            <a href="${item[indexConfig.id_column]}.html">${itemName}</a>
                        </h3>
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${renderInlineBadges(item)}
                        </div>

                        <div class="item-details">
                            ${renderItemFields(item)}
                        </div>

                        <div class="flex flex-wrap gap-2 mt-3">
                            ${renderFieldLinks(item)}
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // Vue liste générique
    function renderListView(items) {
        itemsContainer.className = "items-list";

        // Appliquer les styles directement via JavaScript
        itemsContainer.style.display = 'flex';
        itemsContainer.style.flexDirection = 'column';
        itemsContainer.style.gap = '1rem';
        itemsContainer.style.gridTemplateColumns = ''; // Reset grid styles
        itemsContainer.innerHTML = items.map(item => {
            const imageField = indexConfig.display_fields.find(f => f.display === 'image_preview' || f.type === 'json_array');
            const imageUrl = getImageUrl(item, imageField);
            const nameField = indexConfig.display_fields.find(f => f.name === 'name');
            const itemName = getFieldValue(item, nameField) || item[indexConfig.id_column];

            // Ne pas afficher la section image si aucun champ d'image n'est configuré
            const hasImageField = imageField !== undefined;

            return `
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                <!-- Zone principale : texte à gauche, images à droite -->
                <div class="flex">
                    <!-- Texte à gauche -->
                    <div class="${hasImageField ? 'flex-1 pr-6' : 'flex-1'}">
                        <a href="${item[indexConfig.id_column]}.html"
                           class="text-primary hover:text-green-700 font-semibold text-lg transition-colors block mb-2">
                            ${itemName}
                        </a>
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${renderInlineBadges(item)}
                        </div>
                        ${renderItemFields(item, true)}
                    </div>

                    ${hasImageField ? `
                    <!-- Images à droite -->
                    <div class="flex-shrink-0" style="width: 450px;">
                        ${renderListViewImageGallery(item, imageField)}
                    </div>
                    ` : ''}
                </div>

                <!-- Liens en bas -->
                <div class="mt-4 pt-4 border-t border-gray-100">
                    ${renderFieldLinks(item)}
                </div>
            </div>
            `;
        }).join('');
    }

    // Rendu des champs d'un élément
    function renderItemFields(item, inline = false) {
        return indexConfig.display_fields
            .filter(field => field.name !== 'name' && field.display !== 'hidden' && field.display !== 'image_preview' && field.display !== 'link' && field.type !== 'json_array')
            .map(field => {
                const value = getFieldValue(item, field);
                const label = field.label || field.name;
                const displayValue = formatFieldValue(value, field);

                if (inline) {
                    return `<div class="mt-2"><span class="text-gray-500 text-sm">${label}: <span class="font-medium text-gray-700">${displayValue}</span></span></div>`;
                } else {
                    return `
                        <div class="item-info">
                            <span class="item-info-label">${label}:</span>
                            <span class="item-info-value">${displayValue}</span>
                        </div>
                    `;
                }
            }).join('');
    }

    // Formatage des valeurs de champs
    function formatFieldValue(value, field) {
        // Handle null/undefined values
        if (value === null || value === undefined) {
            return '<span class="text-gray-400 italic">-</span>';
        }

        // Convert string boolean values to actual booleans for comparison
        if (field.type === 'boolean' && typeof value === 'string') {
            value = value.toLowerCase() === 'true';
        }

        switch (field.format) {
            case 'badge':
                if (field.type === 'boolean') {
                    const label = value === true ? (field.true_label || 'Oui') : (field.false_label || 'Non');
                    const colorClass = value === true ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600';
                    return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${label}</span>`;
                }
                return value;
            case 'map':
                if (field.mapping && field.mapping[value]) {
                    return field.mapping[value];
                }
                return value;
            case 'number':
                return new Intl.NumberFormat('fr-FR').format(value);
            default:
                return value;
        }
    }

    // Rendu des badges inline dans le titre
    function renderInlineBadges(item) {
        return indexConfig.display_fields
            .filter(field => field.inline_badge === true)
            .map(field => {
                let value = getFieldValue(item, field);
                if (value === null || value === undefined) return '';

                // Convert string boolean values to actual booleans
                if (field.type === 'boolean' && typeof value === 'string') {
                    value = value.toLowerCase() === 'true';
                }

                return formatInlineBadge(value, field);
            })
            .filter(badge => badge !== '')
            .join('');
    }

    // Formatage des badges inline
    function formatInlineBadge(value, field) {

        switch (field.format) {
            case 'badge':
                if (field.type === 'boolean' && value === true) {
                    const label = field.true_label || field.label || 'Oui';
                    const styleValue = field.badge_color || field.badge_style;

                    // Create the badge with proper class combination
                    if (styleValue && styleValue.includes(':')) {
                        // Inline style
                        return `<span class="field-badge" style="${styleValue}">${label}</span>`;
                    } else if (styleValue) {
                        // CSS classes - combine with field-badge
                        return `<span class="field-badge ${styleValue}">${label}</span>`;
                    } else {
                        // Default styling
                        return `<span class="field-badge">${label}</span>`;
                    }
                }
                break;
            case 'map':
                if (field.mapping && field.mapping[value]) {
                    const label = field.mapping[value];
                    const styleValue = (field.badge_colors && field.badge_colors[value]) ||
                                     (field.badge_styles && field.badge_styles[value]) ||
                                     'bg-gray-600 text-white';
                    const tooltip = field.tooltip_mapping && field.tooltip_mapping[value] || '';

                    // Create the badge with proper class combination
                    let badgeHtml;
                    if (styleValue.includes(':')) {
                        // Inline style
                        badgeHtml = `<span class="field-badge" style="${styleValue}" title="${tooltip}">${label}</span>`;
                    } else {
                        // CSS classes - combine with field-badge
                        badgeHtml = `<span class="field-badge ${styleValue}" title="${tooltip}">${label}</span>`;
                    }

                    return badgeHtml;
                }
                break;
            default:
                if (field.badge_color || field.badge_style) {
                    const styleValue = field.badge_color || field.badge_style;

                    // Create the badge with proper class combination
                    if (styleValue.includes(':')) {
                        // Inline style
                        return `<span class="field-badge" style="${styleValue}">${value}</span>`;
                    } else {
                        // CSS classes - combine with field-badge
                        return `<span class="field-badge ${styleValue}">${value}</span>`;
                    }
                }
        }
        return '';
    }


    // Gestion des vues
    function setView(viewType) {
        currentView = viewType;

        if (viewType === 'grid') {
            gridViewBtn.classList.add('bg-green-600', 'text-white');
            gridViewBtn.classList.remove('bg-white', 'text-gray-700');
            listViewBtn.classList.remove('bg-green-600', 'text-white');
            listViewBtn.classList.add('bg-white', 'text-gray-700');
        } else {
            listViewBtn.classList.add('bg-green-600', 'text-white');
            listViewBtn.classList.remove('bg-white', 'text-gray-700');
            gridViewBtn.classList.remove('bg-green-600', 'text-white');
            gridViewBtn.classList.add('bg-white', 'text-gray-700');
        }

        localStorage.setItem(`${indexConfig.group_by}ViewPreference`, viewType);
        renderItems();
    }

    // Pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationElement.innerHTML = '';
            return;
        }

        const buttonClasses = "px-3 py-2 mx-1 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-50 focus:ring-2 focus:ring-primary focus:border-primary transition-colors";
        const activeButtonClasses = "px-3 py-2 mx-1 text-sm border border-primary rounded-md bg-primary text-white bg-green-600 hover:bg-green-700 transition-colors";
        const disabledButtonClasses = "px-3 py-2 mx-1 text-sm border border-gray-300 rounded-md bg-gray-100 text-gray-400 cursor-not-allowed";

        let paginationHTML = `
            <button onclick="goToPage(1)" class="${currentPage === 1 ? disabledButtonClasses : buttonClasses}" ${currentPage === 1 ? 'disabled' : ''}>
                « Premier
            </button>
            <button onclick="goToPage(${currentPage - 1})" class="${currentPage === 1 ? disabledButtonClasses : buttonClasses}" ${currentPage === 1 ? 'disabled' : ''}>
                ‹ Précédent
            </button>
        `;

        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button onclick="goToPage(${i})" class="${i === currentPage ? activeButtonClasses : buttonClasses}">
                    ${i}
                </button>
            `;
        }

        paginationHTML += `
            <button onclick="goToPage(${currentPage + 1})" class="${currentPage === totalPages ? disabledButtonClasses : buttonClasses}" ${currentPage === totalPages ? 'disabled' : ''}>
                Suivant ›
            </button>
            <button onclick="goToPage(${totalPages})" class="${currentPage === totalPages ? disabledButtonClasses : buttonClasses}" ${currentPage === totalPages ? 'disabled' : ''}>
                Dernier »
            </button>
        `;

        paginationElement.innerHTML = paginationHTML;
    }

    function goToPage(page) {
        currentPage = page;
        renderItems();
        window.scrollTo({ top: itemsContainer.offsetTop - 100, behavior: 'smooth' });
    }

    // Obtenir l'URL de l'image si disponible
    function getImageUrl(item, imageField) {
        if (!imageField) return null;

        const imageData = getFieldValue(item, imageField);
        if (!imageData) return null;

        // Si c'est une URL directe
        if (typeof imageData === 'string' && (imageData.startsWith('http') || imageData.startsWith('/'))) {
            return imageData;
        }

        // Si c'est un tableau d'images
        if (Array.isArray(imageData) && imageData.length > 0) {
            const firstImage = imageData[0];
            return firstImage.small_thumb || firstImage.url || firstImage;
        }

        // Si c'est un objet avec une URL
        if (typeof imageData === 'object' && imageData.url) {
            return imageData.small_thumb || imageData.url;
        }

        return null;
    }

    // Rendu des images pour la vue liste en galerie
    function renderListViewImageGallery(item, imageField) {
        if (!imageField) {
            return '<div class="text-center text-gray-400 text-sm py-4">Aucune image disponible</div>';
        }

        const imageData = getFieldValue(item, imageField);
        if (!imageData) {
            return '<div class="text-center text-gray-400 text-sm py-4">Aucune image disponible</div>';
        }

        let allImages = [];
        let displayImages = [];

        // Si c'est une URL directe
        if (typeof imageData === 'string' && (imageData.startsWith('http') || imageData.startsWith('/'))) {
            allImages = [imageData];
            displayImages = [imageData];
        }
        // Si c'est un tableau d'images
        else if (Array.isArray(imageData)) {
            allImages = imageData.map(img => img.small_thumb || img.url || img);
            displayImages = allImages.slice(0, 10);
        }
        // Si c'est un objet avec une URL
        else if (typeof imageData === 'object' && imageData.url) {
            allImages = [imageData.small_thumb || imageData.url];
            displayImages = allImages;
        }

        if (allImages.length === 0) {
            return '<div class="text-center text-gray-400 text-sm py-4">Aucune image disponible</div>';
        }

        const itemId = item[indexConfig.id_column];
        const galleryId = `gallery-${itemId}`;

        // Préparer les URLs pour la modal (big_thumb)
        const modalImages = Array.isArray(imageData) ?
            imageData.map(img => img.big_thumb || img.url || img) :
            allImages;

        // Créer une grille d'images pour la zone droite
        const imageElements = displayImages.map((imageUrl, index) => {
            return `
                <div class="w-20 h-20 bg-cover bg-center rounded border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity"
                     style="background-image: url('${imageUrl}')"
                     title="Image ${index + 1}"
                     onclick="openImageLightbox(${JSON.stringify(modalImages).replace(/"/g, '&quot;')}, ${index})">
                </div>
            `;
        }).join('');

        // Images supplémentaires cachées
        const hiddenImages = allImages.slice(10).map((imageUrl, index) => {
            return `
                <div class="w-20 h-20 bg-cover bg-center rounded border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity hidden gallery-hidden"
                     style="background-image: url('${imageUrl}')"
                     title="Image ${index + 11}"
                     onclick="openImageLightbox(${JSON.stringify(modalImages).replace(/"/g, '&quot;')}, ${index + 10})">
                </div>
            `;
        }).join('');

        const remainingCount = allImages.length - displayImages.length;
        const expandButton = remainingCount > 0 ? `
            <div class="w-20 h-20 bg-gray-100 rounded border border-gray-200 flex items-center justify-center text-gray-500 text-sm font-medium cursor-pointer hover:bg-gray-200 transition-colors expand-btn"
                 onclick="expandImageGallery('${galleryId}', this)">
                +${remainingCount}
            </div>
        ` : '';

        const collapseButton = remainingCount > 0 ? `
            <div class="w-20 h-20 bg-gray-100 rounded border border-gray-200 flex items-center justify-center text-gray-500 text-sm font-medium cursor-pointer hover:bg-gray-200 transition-colors collapse-btn hidden"
                 onclick="collapseImageGallery('${galleryId}', this)">
                −
            </div>
        ` : '';

        return `
            <div id="${galleryId}" class="grid grid-cols-5 gap-2">
                ${imageElements}
                ${hiddenImages}
                ${expandButton}
                ${collapseButton}
            </div>
        `;
    }

    // Rendu des liens basés sur les champs
    function renderFieldLinks(item) {
        const linkFields = indexConfig.display_fields.filter(field => field.display === 'link');

        if (linkFields.length === 0) {
            return '';
        }

        const links = linkFields
            .map(field => {
                const value = getFieldValue(item, field);
                if (!value) return '';

                let finalUrl;
                if (field.link_template) {
                    // Use template with placeholder replacement
                    finalUrl = field.link_template.replace('{value}', value);
                } else {
                    // Use direct URL
                    finalUrl = value;
                }

                const label = field.link_label || field.label || field.name;
                const cssClass = field.css_class || 'external-link';
                const cssStyle = field.css_style ? `style="${field.css_style}"` : '';
                const title = field.link_title ? `title="${field.link_title}"` : '';
                const target = field.link_target ? `target="${field.link_target}"` : 'target="_blank"';

                return `<a href="${finalUrl}" class="${cssClass}" ${cssStyle} ${title} ${target}>${label}</a>`;
            })
            .filter(link => link !== '');

        if (links.length === 0) return '';

        return links.join(' ');
    }

    // Fonction pour expandre la galerie d'images
    function expandImageGallery(galleryId, button) {
        const gallery = document.getElementById(galleryId);
        const hiddenImages = gallery.querySelectorAll('.gallery-hidden');
        const expandBtn = gallery.querySelector('.expand-btn');
        const collapseBtn = gallery.querySelector('.collapse-btn');

        // Afficher toutes les images cachées
        hiddenImages.forEach(img => img.classList.remove('hidden'));

        // Masquer le bouton + et afficher le bouton −
        expandBtn.classList.add('hidden');
        collapseBtn.classList.remove('hidden');
    }

    // Fonction pour réduire la galerie d'images
    function collapseImageGallery(galleryId, button) {
        const gallery = document.getElementById(galleryId);
        const hiddenImages = gallery.querySelectorAll('.gallery-hidden');
        const expandBtn = gallery.querySelector('.expand-btn');
        const collapseBtn = gallery.querySelector('.collapse-btn');

        // Masquer les images supplémentaires
        hiddenImages.forEach(img => img.classList.add('hidden'));

        // Afficher le bouton + et masquer le bouton −
        expandBtn.classList.remove('hidden');
        collapseBtn.classList.add('hidden');
    }

    // Variables globales pour la navigation dans la modal
    let currentImageArray = [];
    let currentImageIndex = 0;

    // Fonction pour ouvrir une image en grand dans la modal
    function openImageLightbox(images, startIndex = 0) {
        currentImageArray = images;
        currentImageIndex = startIndex;

        showCurrentImage();

        const modal = document.getElementById('imageModal');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Empêcher le scroll de la page

        updateNavigationButtons();
    }

    // Fonction pour afficher l'image actuelle
    function showCurrentImage() {
        const modalImage = document.getElementById('modalImage');
        const imageLoader = document.getElementById('imageLoader');
        const currentIndexSpan = document.getElementById('currentImageIndex');
        const totalImagesSpan = document.getElementById('totalImages');

        // Afficher le loader et cacher l'image
        imageLoader.classList.remove('hidden');
        modalImage.classList.add('hidden');

        // Mettre à jour les compteurs
        currentIndexSpan.textContent = currentImageIndex + 1;
        totalImagesSpan.textContent = currentImageArray.length;

        // Charger la nouvelle image
        const newImage = new Image();
        newImage.onload = function() {
            // Une fois l'image chargée, l'afficher et cacher le loader
            modalImage.src = newImage.src;
            imageLoader.classList.add('hidden');
            modalImage.classList.remove('hidden');
        };
        newImage.onerror = function() {
            // En cas d'erreur, afficher un message et cacher le loader
            imageLoader.innerHTML = '<div class="text-white text-center"><p>Erreur de chargement</p><p class="text-sm opacity-75">Image non disponible</p></div>';
            setTimeout(() => {
                imageLoader.innerHTML = '<div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white"></div>';
                imageLoader.classList.add('hidden');
            }, 2000);
        };
        newImage.src = currentImageArray[currentImageIndex];

        // Afficher/masquer le compteur et les flèches selon le nombre d'images
        const imageCounter = document.getElementById('imageCounter');
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');

        if (currentImageArray.length > 1) {
            imageCounter.classList.remove('hidden');
            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
        } else {
            imageCounter.classList.add('hidden');
            prevBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
        }
    }

    // Fonction pour mettre à jour les boutons de navigation
    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');

        // Désactiver/activer les boutons selon la position
        if (currentImageIndex === 0) {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        } else {
            prevBtn.style.opacity = '1';
            prevBtn.style.cursor = 'pointer';
        }

        if (currentImageIndex === currentImageArray.length - 1) {
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        } else {
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        }
    }

    // Fonction pour aller à l'image précédente
    function previousImage() {
        if (currentImageIndex > 0) {
            currentImageIndex--;
            showCurrentImage();
            updateNavigationButtons();
        }
    }

    // Fonction pour aller à l'image suivante
    function nextImage() {
        if (currentImageIndex < currentImageArray.length - 1) {
            currentImageIndex++;
            showCurrentImage();
            updateNavigationButtons();
        }
    }

    // Fonction pour fermer la modal
    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restaurer le scroll
    }

    // Fermer la modal en cliquant en dehors de l'image
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImageModal();
        }
    });

    // Navigation au clavier
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('imageModal');
        if (!modal.classList.contains('hidden')) {
            switch(e.key) {
                case 'Escape':
                    closeImageModal();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousImage();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextImage();
                    break;
            }
        }
    });

</script>
{% endblock %}
