{% extends '_base.html' %}

{% block title %}Niamoto - Liste des Parcelles{% endblock %}

{% block extra_head %}
<style>
    .search-container {
        position: relative;
        margin-bottom: 2rem;
    }

    #searchInput {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 1rem;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #718096;
    }

    .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #4a5568;
    }

    .filter-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .pagination button {
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.25rem;
        background-color: #f7fafc;
        cursor: pointer;
    }

    .pagination button.active {
        background-color: #57a353;
        color: white;
        border-color: #57a353;
    }

    .pagination button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    .plot-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .plot-card {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
        color: inherit;
        background-color: white;
    }

    .plot-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .plot-card-header {
        padding: 1rem;
        background-color: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    .plot-card-body {
        padding: 1rem;
    }

    .plot-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .plot-info-label {
        color: #718096;
        font-size: 0.875rem;
    }

    .plot-info-value {
        font-weight: 500;
    }

    .no-results {
        text-align: center;
        padding: 3rem;
        color: #718096;
        font-style: italic;
    }

    .stats-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        color: #4a5568;
    }

    .view-toggles {
        display: flex;
        gap: 0.5rem;
    }

    .view-toggle {
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.25rem;
        background-color: #f7fafc;
        cursor: pointer;
    }

    .view-toggle.active {
        background-color: #57a353;
        color: white;
    }

    .substrate-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }

    .substrate-um {
        background-color: #e1a553;
    }

    .substrate-non-um {
        background-color: #a97742;
    }

    .plot-list-view .plot-card {
        display: flex;
        align-items: center;
    }

    .plot-list-view .plot-card-header {
        flex: 0 0 30%;
        border-bottom: 0;
        border-right: 1px solid #e2e8f0;
    }

    .plot-list-view .plot-card-body {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
    }

    .plot-list-view .plot-info {
        width: 33.333%;
        padding-right: 1rem;
    }

    @media (max-width: 768px) {
        .filters-container {
            flex-direction: column;
        }

        .filter-group {
            min-width: 100%;
        }

        .plot-list {
            grid-template-columns: 1fr;
        }

        .plot-list-view .plot-card {
            flex-direction: column;
        }

        .plot-list-view .plot-card-header {
            width: 100%;
            border-right: 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .plot-list-view .plot-info {
            width: 50%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 mt-16">
    <h1 class="text-3xl font-bold mb-6">Peuplements</h1>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Rechercher une parcelle..." aria-label="Rechercher une parcelle">
        <svg class="search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    </div>

    <div class="filters-container">
        <div class="filter-group">
            <label for="substrateFilter" class="filter-label">Substrat</label>
            <select id="substrateFilter" class="filter-select">
                <option value="all">Tous les substrats</option>
                <option value="true">Ultramafique (UM)</option>
                <option value="false">Non-ultramafique (NUM)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="holdridgeFilter" class="filter-label">Milieu de vie</label>
            <select id="holdridgeFilter" class="filter-select">
                <option value="all">Tous les milieux</option>
                <option value="1">Sec</option>
                <option value="2">Humide</option>
                <option value="3">Très humide</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sortBy" class="filter-label">Trier par</label>
            <select id="sortBy" class="filter-select">
                <option value="name">Nom</option>
                <option value="elevation">Altitude</option>
                <option value="rainfall">Pluviométrie</option>
                <option value="occurrences_count">Nombre d'occurrences</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sortOrder" class="filter-label">Ordre</label>
            <select id="sortOrder" class="filter-select">
                <option value="asc">Croissant</option>
                <option value="desc">Décroissant</option>
            </select>
        </div>
    </div>

    <div class="stats-bar">
        <div id="resultCount">Affichage de 0 parcelles sur {{ plots_data|length }}</div>

        <div class="view-toggles">
            <button id="gridViewBtn" class="view-toggle active" title="Vue en grille">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z"/>
                </svg>
            </button>
            <button id="listViewBtn" class="view-toggle" title="Vue en liste">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z"/>
                    <path d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z"/>
                    <path fill-rule="evenodd" d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5V7zM2 7h1v1H2V7zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2zm1 .5H2v1h1v-1z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="plot-list" id="plotList">
        <!-- Les parcelles seront injectées ici via JavaScript -->
    </div>

    <div class="pagination" id="pagination">
        <!-- Les boutons de pagination seront injectés ici via JavaScript -->
    </div>

    <div class="no-results hidden" id="noResults">
        <p>Aucune parcelle trouvée pour cette recherche.</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Données des parcelles
    const allPlots = {{ plots_data|tojson|safe }};

    // Mapping pour les valeurs de holdridge
    const holdridgeMapping = {
        '1': 'Sec',
        '2': 'Humide',
        '3': 'Très humide'
    };

    // Configuration
    const itemsPerPage = 12;
    let currentPage = 1;
    let filteredPlots = [...allPlots];
    let currentView = 'grid'; // 'grid' ou 'list'

    // Éléments DOM
    const plotListElement = document.getElementById('plotList');
    const paginationElement = document.getElementById('pagination');
    const searchInput = document.getElementById('searchInput');
    const substrateFilter = document.getElementById('substrateFilter');
    const holdridgeFilter = document.getElementById('holdridgeFilter');
    const sortBySelect = document.getElementById('sortBy');
    const sortOrderSelect = document.getElementById('sortOrder');
    const noResultsElement = document.getElementById('noResults');
    const resultCountElement = document.getElementById('resultCount');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Premier rendu
        applyFiltersAndSort();

        // Event listeners
        searchInput.addEventListener('input', applyFiltersAndSort);
        substrateFilter.addEventListener('change', applyFiltersAndSort);
        holdridgeFilter.addEventListener('change', applyFiltersAndSort);
        sortBySelect.addEventListener('change', applyFiltersAndSort);
        sortOrderSelect.addEventListener('change', applyFiltersAndSort);

        // Toggle vue grille/liste
        gridViewBtn.addEventListener('click', function() {
            setView('grid');
        });

        listViewBtn.addEventListener('click', function() {
            setView('list');
        });

        // Restaurer les préférences utilisateur si disponibles
        const savedView = localStorage.getItem('plotViewPreference');
        if (savedView) {
            setView(savedView);
        }
    });

    // Définir le mode d'affichage (grille ou liste)
    function setView(viewType) {
        currentView = viewType;

        // Mettre à jour les boutons
        if (viewType === 'grid') {
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            plotListElement.classList.add('plot-list');
            plotListElement.classList.remove('plot-list-view');
        } else {
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
            plotListElement.classList.remove('plot-list');
            plotListElement.classList.add('plot-list-view');
        }

        // Sauvegarder la préférence
        localStorage.setItem('plotViewPreference', viewType);

        // Re-render avec la nouvelle vue
        renderPlotList();
    }

    // Appliquer les filtres et le tri
    function applyFiltersAndSort() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const substrateValue = substrateFilter.value;
        const holdridgeValue = holdridgeFilter.value;
        const sortBy = sortBySelect.value;
        const sortOrder = sortOrderSelect.value;

        // Filtrer
        filteredPlots = allPlots.filter(plot => {
            // Filtre de recherche
            const matchesSearch = plot.name.toLowerCase().includes(searchTerm);

            // Filtre de substrat
            const matchesSubstrate = substrateValue === 'all' ||
                                   (substrateValue === 'true' && plot.in_um === true) ||
                                   (substrateValue === 'false' && (plot.in_um === false || plot.in_um === undefined));

            // Filtre de holdridge
            const matchesHoldridge = holdridgeValue === 'all' ||
                                   String(plot.holdridge) === holdridgeValue;

            return matchesSearch && matchesSubstrate && matchesHoldridge;
        });

        // Trier
        filteredPlots.sort((a, b) => {
            let comparison = 0;

            if (sortBy === 'name') {
                comparison = a.name.localeCompare(b.name);
            } else if (sortBy === 'elevation') {
                const elevA = a.elevation || 0;
                const elevB = b.elevation || 0;
                comparison = elevA - elevB;
            } else if (sortBy === 'rainfall') {
                const rainA = a.rainfall || 0;
                const rainB = b.rainfall || 0;
                comparison = rainA - rainB;
            } else if (sortBy === 'occurrences_count') {
                const occA = a.occurrences_count || 0;
                const occB = b.occurrences_count || 0;
                comparison = occA - occB;
            }

            // Inverser si l'ordre est décroissant
            return sortOrder === 'desc' ? -comparison : comparison;
        });

        // Réinitialiser la pagination
        currentPage = 1;

        // Afficher
        renderPlotList();
    }

    // Rendu de la liste des parcelles
    function renderPlotList() {
        // Afficher le message "pas de résultats" si nécessaire
        if (filteredPlots.length === 0) {
            plotListElement.innerHTML = '';
            paginationElement.innerHTML = '';
            noResultsElement.classList.remove('hidden');
            resultCountElement.textContent = 'Aucune parcelle trouvée';
            return;
        }

        noResultsElement.classList.add('hidden');

        // Calculer les indices de début et de fin pour la pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredPlots.length);
        const currentPlots = filteredPlots.slice(startIndex, endIndex);

        // Mettre à jour le compteur de résultats
        resultCountElement.textContent = `Affichage de ${startIndex + 1}-${endIndex} sur ${filteredPlots.length} parcelles`;

        // Générer le HTML en fonction de la vue
        if (currentView === 'grid') {
            renderGridView(currentPlots);
        } else {
            renderListView(currentPlots);
        }

        // Générer la pagination
        renderPagination();
    }

    // Rendu en mode grille
    function renderGridView(plots) {
        plotListElement.className = "plot-list";
        plotListElement.innerHTML = plots.map(plot => `
            <a href="{{ depth }}plot/${plot.id}.html" class="plot-card">
                <div class="plot-card-header">
                    <h3 class="font-bold text-lg">${plot.name}</h3>
                </div>
                <div class="plot-card-body">
                    ${plot.elevation ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Altitude:</span>
                        <span class="plot-info-value">${plot.elevation.value} m</span>
                    </div>
                    ` : ''}

                    ${plot.rainfall ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Précipitation:</span>
                        <span class="plot-info-value">${plot.rainfall.value} mm/an</span>
                    </div>
                    ` : ''}

                    ${plot.holdridge ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Milieu:</span>
                        <span class="plot-info-value">${holdridgeMapping[plot.holdridge.value] || plot.holdridge.value}</span>
                    </div>
                    ` : ''}

                    ${plot.in_um ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Substrat:</span>
                        <span class="plot-info-value">
                            ${plot.in_um === true
                                ? '<span class="substrate-indicator substrate-um"></span>Ultramafique'
                                : '<span class="substrate-indicator substrate-non-um"></span>Non-ultramafique'}
                        </span>
                    </div>
                    ` : ''}

                    ${plot.occurrences_count ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Occurrences:</span>
                        <span class="plot-info-value">${plot.occurrences_count.value}</span>
                    </div>
                    ` : ''}

                    ${plot.nb_species ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Nombre d'espèces:</span>
                        <span class="plot-info-value">${plot.nb_species.value}</span>
                    </div>
                    ` : ''}
                </div>
            </a>
        `).join('');
    }

    // Rendu en mode liste
    function renderListView(plots) {
        plotListElement.className = "plot-list-view space-y-2";
        plotListElement.innerHTML = plots.map(plot => `
            <a href="{{ depth }}plot/${plot.id}.html" class="plot-card">
                <div class="plot-card-header">
                    <h3 class="font-bold text-lg">${plot.name}</h3>
                </div>
                <div class="plot-card-body">
                    ${plot.elevation ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Altitude:</span>
                        <span class="plot-info-value">${plot.elevation.value} m</span>
                    </div>
                    ` : ''}

                    ${plot.rainfall ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Précipitation:</span>
                        <span class="plot-info-value">${plot.rainfall.value} mm/an</span>
                    </div>
                    ` : ''}

                    ${plot.holdridge ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Milieu:</span>
                        <span class="plot-info-value">${holdridgeMapping[plot.holdridge.value] || plot.holdridge.value}</span>
                    </div>
                    ` : ''}

                    <div class="plot-info">
                        <span class="plot-info-label">Substrat:</span>
                        <span class="plot-info-value">
                            ${plot.in_um === true
                                ? '<span class="substrate-indicator substrate-um"></span>Ultramafique'
                                : '<span class="substrate-indicator substrate-non-um"></span>Non-ultramafique'}
                        </span>
                    </div>

                    ${plot.occurrences_count ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Occurrences:</span>
                        <span class="plot-info-value">${plot.occurrences_count.value}</span>
                    </div>
                    ` : ''}

                    ${plot.nb_species ? `
                    <div class="plot-info">
                        <span class="plot-info-label">Nombre d'espèces:</span>
                        <span class="plot-info-value">${plot.nb_species.value}</span>
                    </div>
                    ` : ''}
                </div>
            </a>
        `).join('');
    }

    // Rendu de la pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredPlots.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationElement.innerHTML = '';
            return;
        }

        let paginationHTML = `
            <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>
                &laquo; Premier
            </button>
            <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                &lsaquo; Précédent
            </button>
        `;

        // Afficher un nombre limité de pages
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">
                    ${i}
                </button>
            `;
        }

        paginationHTML += `
            <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                Suivant &rsaquo;
            </button>
            <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                Dernier &raquo;
            </button>
        `;

        paginationElement.innerHTML = paginationHTML;
    }

    // Navigation entre les pages
    function goToPage(page) {
        currentPage = page;
        renderPlotList();
        // Scroll vers le haut de la liste
        window.scrollTo({ top: plotListElement.offsetTop - 100, behavior: 'smooth' });
    }
</script>
{% endblock %}
