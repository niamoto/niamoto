{% macro render_widget(widget, content) %}
<div class="bg-white rounded-lg shadow-lg overflow-hidden mb-4 md:mb-0">
    <div class="bg-gray-600 text-white p-3 flex justify-between items-center">
        <h2 class="text-lg">{{ widget.title }}</h2>
        {% if widget.description %}
        <button class="bg-white rounded-full w-6 h-6 flex items-center justify-center text-gray-600 relative group">
            <i class="fas fa-info"></i>
            <span
                class="tooltip-content hidden group-hover:block absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 md:w-64 bg-white p-2 rounded shadow-lg text-sm z-50">
                {{ widget.description }}
            </span>
        </button>
        {% endif %}
    </div>
    <div class="p-4">
        {{ content | safe }}
    </div>
</div>
{% endmacro %}

{% macro render_widget_content(widget, widget_key, stats) %}
{% if widget.type == 'map_panel' %}
{% set content = render_map_content(widget, widget_key) %}
{% elif widget.type == 'info_panel' %}
{% set content = render_info_panel_content(widget, stats[widget_key]|from_json, stats) %}
{% elif '_chart' in widget.type %}
{% set content = render_chart_content(widget, widget_key) %}
{% elif widget.type == 'gauge' %}
{% set content = render_gauge_content(widget, widget_key) %}
{% endif %}
{{ render_widget(widget, content) }}
{% endmacro %}

{% macro render_info_panel_content(widget, data, stats) %}
<!-- Information panel content -->
<div class="space-y-1 md:space-y-1">
    {% for item in widget.fields %}
    {# Get the value - check if external data source is specified #}
    {% if item.data_source %}
      {% set value_data = stats[item.data_source]|from_json %}
      {% set value_data = value_data[item.source] if value_data[item.source] is defined else none %}
    {% else %}
      {% set value_data = data[item.source] if data[item.source] is defined else none %}
    {% endif %}

    {# Vérifier si la donnée existe et que sa valeur n'est pas null, None ou 'None' #}
    {% if value_data is defined and value_data is not none
    and value_data.value is defined and value_data.value is not none
    and value_data.value != 'None' and value_data.value != 'null' %}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-1 {% if not loop.last %}border-b border-gray-100{% endif %}">
        <span class="text-gray-600 text-sm md:text-base mb-0 sm:mb-0">{{ item.label }}</span>
        <span class="font-medium text-sm md:text-base">
            {% if item.format == 'range' %}
            {{ value_data.min }} - {{ value_data.max }} {{ value_data.units or '' }}
            {% elif item.format == 'number' %}
            {{ value_data.value | numberformat }} {{ value_data.units or '' }}
            {% elif item.format == 'map' %}
            {% set value = value_data.value %}
            {% if item.mapping %}
            {% set mapping_key = value|string %}
            {% if mapping_key in item.mapping %}
            {{ item.mapping[mapping_key] }}
            {% else %}
            {{ value }}
            {% endif %}
            {% else %}
            {{ value }}
            {% endif %}
            {% elif item.format == 'link' %}
            <a href="{% if item.base_url %}{{ item.base_url }}{{ value_data.value }}{% else %}{{ value_data.value }}{% endif %}" target="_blank"
                class="text-green-600 hover:text-green-800 underline">
                {% if item.display_text %}{{ item.display_text }}{% else %}{{ item.label }}{% endif %}
                <i class="fas fa-external-link-alt ml-1"></i>
            </a>
            {% elif item.format == 'image' %}
            {% if value_data.value %}
            {% if item.source == 'images' %}
            {% set unique_id = item.source|replace('.', '_') ~ '_' ~ loop.index0 %}
            <div class="flex flex-col gap-2 items-end">
                <div id="images-{{ unique_id }}" class="flex flex-wrap gap-2 justify-end">
                    <div id="loading-images-{{ unique_id }}" class="text-center w-full">
                        <div
                            class="inline-block animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-green-500">
                        </div>
                        <span class="ml-2 text-sm text-gray-500">Chargement des images...</span>
                    </div>
                </div>
                <button onclick="toggleImages('{{ unique_id }}')" id="toggle-{{ unique_id }}"
                    class="w-6 h-6 rounded-full bg-green-100 hover:bg-green-200 flex items-center justify-center transition-colors duration-200 hidden"
                    title="Afficher plus d'images">
                    <i class="fas fa-plus text-green-600" id="icon-{{ unique_id }}"></i>
                </button>
            </div>

            {# Modal dialog #}
            <dialog id="imageModal">
                <div class="relative w-full h-full flex items-center justify-center p-4">
                    <div class="relative bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-hidden">
                        <!-- Le loader sera inséré ici par le JavaScript -->
                        <img id="modalImage" src="" alt="" class="max-h-[80vh] w-auto">
                        <div class="absolute bottom-0 w-full bg-black bg-opacity-50 text-white p-2">
                            <p id="modalCaption" class="text-center"></p>
                        </div>
                        <button onclick="closeModal()"
                            class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </dialog>


            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const imagesContainer = document.getElementById('images-{{ unique_id }}');
                    const loadingElement = document.getElementById('loading-images-{{ unique_id }}');
                    const toggleButton = document.getElementById('toggle-{{ unique_id }}');

                    try {
                        // Retrieve the JSON string from Jinja2
                        const imagesRawDataString = {{ value_data.value | tojson | safe
                    }};
                // Clean escaped characters and convert to valid JSON
                const cleanedJsonString = imagesRawDataString
                    .replace(/\\u0027/g, "'") // Replace \u0027 with '
                    .replace(/'/g, '"');      // Replace ' with " for valid JSON
                const imagesRawData = JSON.parse(cleanedJsonString);
                const images = [];

                // Retrieve the image mapping defined in the configuration
                    const imageMapping = {{ item.image_mapping | tojson | safe }} || {
                        url: "url",
                        thumbnail: "small_thumb",
                        author: "auteur",
                        date: "datmaj"
                    };

                // Process the image array with the custom mapping
                    if (Array.isArray(imagesRawData)) {
                        imagesRawData.forEach(img => {
                            // Retrieve values based on the mapping
                            const url = img[imageMapping.url] || '';
                            const thumbnail = img[imageMapping.thumbnail] || url || '';
                            const author = img[imageMapping.author] || '';
                            const date = img[imageMapping.date] || '';

                            // Check if at least one URL is available
                            if (url || thumbnail) {
                                images.push({
                                    url: url,
                                    thumbnail: thumbnail,
                                    author: author,
                                    date: date
                                });
                            }
                        });
                    }

                // Remove the loading indicator
                if (loadingElement) {
                    loadingElement.remove();
                }

                // Display the images
                if (images.length > 0) {
                        images.forEach((image, index) => {
                            const imgUrl = image.url;
                            const thumbUrl = image.thumbnail;
                            const author = image.author || '';
                            const date = image.date || '';

                        const imageButton = document.createElement('button');
                        imageButton.className = `relative group ${index >= 5 ? 'hidden' : ''} border-0 p-0 bg-transparent cursor-pointer`;
                        imageButton.title = author ? `Photo: ${author}` : 'Photo';
                        imageButton.onclick = function () { openModal(imgUrl, author, date); };

                        const img = document.createElement('img');
                        img.src = thumbUrl;
                        img.alt = author ? `Photo par ${author}` : 'Photo';
                        img.className = 'w-20 h-20 object-cover rounded transition-transform duration-200 group-hover:scale-105';
                        img.dataset.errorHandled = 'false'; // Flag to avoid infinite loop
                        img.onerror = function () {
                            if (this.dataset.errorHandled === 'false') {
                                // Use a valid public URL as a fallback
                                this.src = 'https://via.placeholder.com/150?text=Image+non+disponible';
                                this.dataset.errorHandled = 'true'; // Mark as handled
                            }
                        };

                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 rounded transition-all duration-200';

                        imageButton.appendChild(img);
                        imageButton.appendChild(overlay);

                        if (author) {
                            const attribution = document.createElement('div');
                            attribution.className = 'absolute bottom-0 right-0 bg-black bg-opacity-50 text-white text-[10px] p-1 rounded-bl rounded-tr opacity-0 group-hover:opacity-100 transition-opacity duration-200';
                            attribution.textContent = `© ${author}`;
                            imageButton.appendChild(attribution);
                        }

                        imagesContainer.appendChild(imageButton);
                    });

                    if (images.length > 5) {
                        toggleButton.classList.remove('hidden');
                    }
                } else {
                    const noImages = document.createElement('p');
                    noImages.className = 'text-gray-500 italic';
                    noImages.textContent = 'Aucune image disponible';
                    imagesContainer.appendChild(noImages);
                }
                                        } catch (error) {
                    console.error('Erreur lors du traitement des images:', error);
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'text-red-500 italic';
                    errorMsg.textContent = 'Erreur lors du chargement des images';
                    imagesContainer.appendChild(errorMsg);
                }
                                    });

                function openModal(imgSrc, author, date) {
                        const modal = document.getElementById('imageModal');
                        const modalImg = document.getElementById('modalImage');
                        const modalCaption = document.getElementById('modalCaption');

                        // Add a loader and hide the previous image
                        modalImg.style.display = 'none';

                        // Create or get the loading element
                        let loader = document.getElementById('modalLoader');
                        if (!loader) {
                            loader = document.createElement('div');
                            loader.id = 'modalLoader';
                            loader.className = 'flex justify-center items-center p-8';
                            loader.innerHTML = '<div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"></div><span class="ml-2 text-gray-500">Chargement...</span>';
                            modalImg.parentNode.insertBefore(loader, modalImg);
                        } else {
                            loader.style.display = 'flex';
                        }

                        // Reset the image source
                        modalImg.src = '';
                        modalCaption.textContent = '';
                        modal.showModal();

                        // Load the new image
                        const newImg = new Image();
                        newImg.onload = function () {
                            // Once the image is loaded, hide the loader and display the image
                            if (loader) loader.style.display = 'none';
                            modalCaption.textContent = author ? `© ${author} ${date ? `(${date})` : ''}` : '';
                            modalImg.src = imgSrc;
                            modalImg.style.display = 'block';
                        };

                        newImg.onerror = function () {
                            // In case of loading error
                            if (loader) loader.style.display = 'none';
                            modalImg.src = 'https://via.placeholder.com/400?text=Image+non+disponible';
                            modalImg.style.display = 'block';
                        };

                        newImg.src = imgSrc;

                        modal.addEventListener('click', function (event) {
                            if (event.target === modal) {
                                closeModal();
                            }
                        });
                    }

                    function closeModal() {
                        const modal = document.getElementById('imageModal');
                        modal.close();
                    }

                function toggleImages(id) {
                    const container = document.getElementById('images-' + id);
                    const button = document.getElementById('toggle-' + id);
                    const icon = document.getElementById('icon-' + id);
                    const images = container.querySelectorAll('button');
                    const isExpanded = icon.classList.contains('fa-minus');

                    images.forEach((img, index) => {
                        if (index >= 5) {
                            img.classList.toggle('hidden');
                        }
                    });

                    icon.classList.toggle('fa-plus');
                    icon.classList.toggle('fa-minus');
                    button.title = isExpanded ? "Afficher plus d'images" : "Afficher moins d'images";
                }
            </script>
            {% else %}
            {# Single image #}
            <img src="{{ value_data.value }}" alt="{{ item.label }}" class="w-20 h-20 object-cover rounded">
            {% endif %}
            {% else %}
            <span class="text-gray-400">---</span>
            {% endif %}
            {% else %}
            {{ value_data.value }} {{ value_data.units or '' }}
            {% endif %}
        </span>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endmacro %}

{% macro render_chart_content(widget, widget_key) %}
<div class="chart-container h-48 sm:h-64 md:h-72 lg:h-80">
    <canvas id="{{ widget.id or widget_key + 'Chart' }}"></canvas>
</div>
{% endmacro %}

{% macro render_gauge_content(widget, widget_key) %}
<div class="gauge-container" style="height: {{ widget.height or '300px' }};">
    <div id="{{ widget.id or widget_key + 'Gauge' }}"></div>
</div>
{% endmacro %}

{% macro render_map_content(widget, widget_key) %}
<div class="h-96">
    <div id="{{ widget.id or widget_key + 'Map' }}" class="w-full h-full"></div>
</div>
{% endmacro %}

<!-- Taxon and plot page macros -->

{% macro render_geography_field(field_key) %}
<div class="w-full px-2 mb-4">
    <div id="mapContainer" class="map-container" style="height: 400px; position: relative;">
<div class="loader-container" id="mapLoader">
    <div class="loader"></div>
        </div>
        <!-- The Leaflet map will be loaded here -->
    </div>
</div>
{% endmacro %}

{% macro render_info_widget(title, name, data) %}
<div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <div class="bg-gray-600 text-white p-3">
        <h2 class="text-lg">{{ title }}</h2>
    </div>
    <div class="p-6 space-y-4">
        <h3 class="text-lg font-bold text-gray-800 mb-4">{{ name }}</h3>
        {% for item in data %}
        <div class="flex justify-between items-start">
            <span class="text-gray-600">{{ item.label }}:</span>
            <span class="font-medium text-right">{{ item.value }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endmacro %}

{% macro render_chart(transformation, field_key) %}
{% if transformation.chart_type == 'text' %}
<div class="w-full">
    <p id="{{ field_key }}Text"></p>
</div>
{% elif transformation.chart_type == 'pie' %}
<div class="h-64 w-full">
    <canvas id="{{ field_key }}PieChart" class="w-full h-full"></canvas>
</div>
{% elif transformation.chart_type == 'gauge' %}
<div class="h-64 w-full">
    <div id="{{ field_key }}{{ transformation.name if transformation.name is not none else '' }}Gauge"
        class="w-full h-full"></div>
</div>
{% elif transformation.name == 'temporal_phenology' %}
<div class="h-64 w-full">
    <canvas id="{{ field_key }}TemporalPhenologyChart" class="w-full h-full"></canvas>
</div>
{% elif transformation.chart_type == 'bar' %}
<div class="h-64 w-full">
    <canvas id="{{ field_key }}{{ transformation.name if transformation.name is not none else '' }}BarChart"
        class="w-full h-full"></canvas>
</div>
{% endif %}
{% endmacro %}

{% macro render_field(field_key, field) %}
{% if field.bins and field.bins.values is defined %}
<div class="bg-white rounded-lg shadow-lg overflow-hidden mb-4 md:mb-0">
    <div class="bg-gray-600 text-white p-3 flex justify-between items-center">
        <h2 class="text-lg">{{ field.bins.chart_options.title }}</h2>
        {% if field.description %}
        <button class="bg-white rounded-full w-6 h-6 flex items-center justify-center text-gray-600 relative group">
            <i class="fas fa-info"></i>
            <span
                class="tooltip-content hidden group-hover:block absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 md:w-64 bg-white p-2 rounded shadow-lg text-sm z-50">
                {{ field.description }}
            </span>
        </button>
        {% endif %}
    </div>
    <div class="p-4">
        <canvas id="{{ field.source_field }}BinChart"></canvas>
    </div>
</div>
{% endif %}
{% for transformation in field.transformations %}
{% if transformation.chart_options is defined and transformation.chart_type != 'text' %}
<div class="bg-white rounded-lg shadow-lg overflow-hidden mb-4 md:mb-0">
    <div class="bg-gray-600 text-white p-3 flex justify-between items-center">
        <h2 class="text-lg">{{ transformation.chart_options.title }}</h2>
        {% if field.description %}
        <button class="bg-white rounded-full w-6 h-6 flex items-center justify-center text-gray-600 relative group">
            <i class="fas fa-info"></i>
            <span
                class="tooltip-content hidden group-hover:block absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 md:w-64 bg-white p-2 rounded shadow-lg text-sm z-50">
                {{ field.description }}
            </span>
        </button>
        {% endif %}
    </div>
    <div class="p-4">
        {{ render_chart(transformation, field_key) }}
    </div>
</div>
{% endif %}
{% endfor %}
{% endmacro %}
