##################################################################
# 1) CONFIG POUR LES TAXONS
##################################################################
- group_by: taxon
  source:
    data: occurrences
    grouping: taxon_ref
    relation:
      plugin: nested_set
      key: id_taxonref
      fields:
        parent: parent_id
        left: lft
        right: rght

  widgets_data:
    general_info:
      plugin: field_aggregator
      params:
        fields:
          - source: taxonomy
            field: full_name
            target: name
          - source: taxonomy
            field: rank_name
            target: rank
          - source: occurrences
            field: id
            target: occurrences_count
            transformation: count
      # ex:
      # {
      #   "name": "Araucaria columnaris",
      #   "rank": "espèce",
      #   "occurrences_count": 325
      # }

    distribution_map:
      plugin: geospatial_extractor
      params:
        source: occurrences
        field: geo_pt
        format: geojson
        properties: ["taxonref", "dbh", "height"]
        group_by_coordinates: true
      # ex:
      # {
      #   "type": "FeatureCollection",
      #   "features": [
      #     {
      #       "type": "Feature",
      #       "geometry": {
      #         "type": "Point",
      #         "coordinates": [166.45, -22.18]
      #       }
      #     }
      #   ]
      # }

    top_species:
      plugin: top_ranking
      params:
        source: occurrences
        field: id_taxonref
        target_ranks: ["espèce", "sous-espèce"]
        count: 10
      # ex:
      # {
      #   "tops": ["Taxon1", "Taxon2", "Taxon3"],
      #   "counts": [10, 5, 2]
      # }

    distribution_substrat:
      plugin: binary_counter
      params:
        source: occurrences
        field: in_um
        true_label: "um"
        false_label: "num"
      # ex:
      # {
      #   "um": 230,
      #   "num": 95
      # }

    phenology:
      plugin: "transform_chain"
      params:
        steps:
          # Distribution de la phénologie
          - plugin: "time_series_analysis"
            params:
              source: occurrences
              fields:
                fleur: flower
                fruit: fruit
              time_field: month_obs
              labels: ["Jan", "Fev", "Mar", "Avr", "Mai", "Jun", "Jul", "Aou", "Sep", "Oct", "Nov", "Dec"]
            output_key: "phenology_raw"

          # Détection des pics de floraison/fructification
          - plugin: "custom_calculator"
            params:
              operation: "peak_detection"
              time_series: "@phenology_raw.month_data"
              threshold: 30
            output_key: "phenology_peaks"

          # Calcul des périodes actives
          - plugin: "custom_calculator"
            params:
              operation: "active_periods"
              time_series: "@phenology_raw.month_data"
              labels: "@phenology_raw.labels"
            output_key: "phenology_periods"

          # Fusion des résultats
          - plugin: "custom_calculator"
            params:
              operation: "custom_formula"
              formula: "{'raw': phenology_raw, 'peaks': phenology_peaks, 'periods': phenology_periods}"
              variables:
                phenology_raw: "@phenology_raw"
                phenology_peaks: "@phenology_peaks"
                phenology_periods: "@phenology_periods"
            output_key: "phenology_data"

    phenology_distribution:
      plugin: time_series_analysis
      params:
        source: occurrences
        fields:
          fleur: flower
          fruit: fruit
        time_field: month_obs
        labels: ["Jan", "Fev", "Mar", "Avr", "Mai", "Jun", "Jul", "Aou", "Sep", "Oct", "Nov", "Dec"]
      # ex:
      # {
      #   "month_data": {
      #     "fleur": [10, 20, 35, 45, 30, 20, 15, 10, 5, 15, 25, 30],
      #     "fruit": [5, 15, 25, 35, 45, 40, 30, 20, 15, 10, 5, 10]
      #   },
      #   "labels": ["Jan", "Fev", "Mar", "Avr", "Mai", "Jun", "Jul", "Aou", "Sep", "Oct", "Nov", "Dec"]
      # }

    dbh_distribution:
      plugin: binned_distribution
      params:
        source: occurrences
        field: dbh
        bins: [10, 20, 30, 40, 50, 75, 100, 200, 300, 400, 500]
      # ex:
      # {
      #   "bins": [10, 20, 30, 40, 50, 75, 100, 200, 300, 400, 500],
      #   "counts": [45, 78, 92, 64, 38, 25, 12, 8, 3, 1]
      # }

    dbh_max:
      plugin: statistical_summary
      params:
        source: occurrences
        field: dbh
        stats: ["min", "mean", "max"]
        units: "cm"
        max_value: 500
      # ex:
      # {
      #   "min": 320,
      #   "mean": 400,
      #   "max": 500,
      #   "max_value": 500
      #   "units": "cm"
      # }

    height_max:
      plugin: statistical_summary
      params:
        source: occurrences
        field: height
        stats: ["max"]
        units: "m"
        max_value: 40
      # ex:
      # {
      #   "max": 30,
      #   "max_value": 40
      #   "units": "m"
      # }

    elevation_distribution:
      plugin: binned_distribution
      params:
        source: occurrences
        field: elevation
        bins: [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1700]
      # ex:
      # {
      #   "bins": [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1700],
      #   "counts": [45, 78, 92, 64, 38, 25, 12, 8, 3, 1, 0, 0]
      # }

    wood_density:
      plugin: statistical_summary
      params:
        source: occurrences
        field: wood_density
        stats: ["min", "mean", "max"]
        units: "g/cm3"
        max_value: 1.2
      # ex:
      # {
      #   "min": 0.35,
      #   "mean": 0.65,
      #   "max": 0.95,
      #   "units": "g/cm3"
      # }

    rainfall_distribution:
      plugin: binned_distribution
      params:
        source: occurrences
        field: rainfall
        bins: [1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000]
      # ex:
      # {
      #   "bins": [1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000],
      #   "counts": [45, 78, 92, 64, 38, 25, 12, 8, 3]
      # }

    holdridge_distribution:
      plugin: categorical_distribution
      params:
        source: occurrences
        field: holdridge
        categories: [1, 2, 3]
        labels: ["Sec", "Humide", "Très humide"]
      # ex:
      # {
      #   "bins": [1, 2, 3],
      #   "labels": ["Sec", "Humide", "Très humide"],
      #   "counts": [45, 78, 92]
      # }

    strata_distribution:
      plugin: categorical_distribution
      params:
        source: occurrences
        field: strata
        categories: [1, 2, 3, 4]
        labels: ["Sous-bois", "Sous-Canopée", "Canopée", "Emergent"]
      # ex:
      # {
      #   "bins": [1, 2, 3, 4],
      #   "labels": ["Sous-bois", "Sous-Canopée", "Canopée", "Emergent"],
      #   "counts": [45, 78, 92, 64]
      # }

    bark_thickness:
      plugin: statistical_summary
      params:
        source: occurrences
        field: bark_thickness
        stats: ["min", "mean", "max"]
        units: "mm"
        max_value: 80
      # ex:
      # {
      #   "min": 2.5,
      #   "mean": 15.3,
      #   "max": 45.8,
      #   "units": "mm"
      # }

    leaf_sla:
      plugin: statistical_summary
      params:
        source: occurrences
        field: leaf_sla
        stats: ["min", "mean", "max"]
        units: "g/m2"
        max_value: 50
      # ex:
      # {
      #   "min": 8.5,
      #   "mean": 22.4,
      #   "max": 38.2,
      #   "units": "g/m2"
      # }

    leaf_area:
      plugin: statistical_summary
      params:
        source: occurrences
        field: leaf_area
        stats: ["mean"]
        units: "cm2"
        max_value: 1500
      # ex:
      # {
      #   "max": 60.8,
      #   "units": "cm2"
      # }

    leaf_thickness:
      plugin: statistical_summary
      params:
        source: occurrences
        field: leaf_thickness
        stats: ["mean"]
        units: "µm"
        max_value: 800
      # ex:
      # {
      #   "max": 301.6,
      #   "units": "µm"
      # }

##################################################################
# 2) CONFIG POUR LES PLOTS
##################################################################
- group_by: plot
  source:
    data: occurrences
    grouping: plot_ref
    relation:
      plugin: join_table
      key: id_plot
      join_table: occurrences_plots
      keys:
        source: id_occurrence
        reference: id_plot

  widgets_data:
    general_info:
      plugin: field_aggregator
      params:
        fields:
          - source: plots
            field: locality
            target: plot_name
          - source: plots
            field: elevation
            target: elevation
            units: "m"
          - source: plots
            field: rainfall
            target: rainfall
            units: "mm/an"
          - source: plots
            field: holdridge
            target: holdridge
          - source: plots
            field: substrat
            target: substrat
          - source: plots
            field: nb_families
            target: nb_families
          - source: plots
            field: nb_species
            target: nb_species
          - source: occurrences
            field: id
            target: occurrences_count
            transformation: count

    map_panel:
      plugin: geospatial_extractor
      params:
        source: plots
        field: geometry
      # ex: { "coordinates": [...], "label": ... }

    top_families:
      plugin: top_ranking
      params:
        source: occurrences
        target_ranks: ["famille"]
        count: 10
      # ex: { "labels": [...], "values": [...] }

    top_species:
      plugin: top_ranking
      params:
        source: occurrences
        target_ranks: ["espèce", "sous-espèce"]
        count: 10
      # ex:
      # {
      #   "tops": ["Taxon1", "Taxon2", "Taxon3"],
      #   "counts": [10, 5, 2]
      # }

    dbh_distribution:
      plugin: binned_distribution
      params:
        source: occurrences
        field: dbh
        bins: [10, 20, 30, 40, 50, 75, 100, 200, 300, 400, 500]
      # ex:
      # {
      #   "bins": [10, 20, 30, 40, 50, 75, 100, 200, 300, 400, 500],
      #   "counts": [45, 78, 92, 64, 38, 25, 12, 8, 3, 1]
      # }

    strata_distribution:
      plugin: categorical_distribution
      params:
        source: occurrences
        field: strata
        categories: [1, 2, 3, 4]
        labels: ["Sous-Bois", "Sous-Canopée", "Canopée", "Emergent"]
      # ex: { "bins": [...], "counts": [...] }

    height:
      plugin: statistical_summary
      params:
        source: occurrences
        field: height
        stats: ["mean"]
        units: "m"
        max_value: 40
      # ex: { "value": 25, "max": 40, "units": "m" }

    wood_density:
      plugin: statistical_summary
      params:
        source: occurrences
        field: wood_density
        stats: ["mean"]
        units: "g/cm3"
        max_value: 1.2
      # ex: { "value": 0.65, "max": 1.2, "units": "g/cm3" }

    basal_area:
      plugin: direct_attribute
      params:
        source: plots
        field: basal_area
        units: "m²/ha"
        max_value: 100
      # ex: { "value": 25, "max": 100, "units": "m²/ha" }

    richness:
      plugin: direct_attribute
      params:
        source: plots
        field: nb_species
        units: "Nombre d'espèces/ha"
        max_value: 130
      # ex: { "value": 25, "max": 50, "units": "" }

    shannon:
      plugin: direct_attribute
      params:
        source: plots
        field: shannon
        max_value: 5
      # ex: { "value": 2.5, "max": 5, "units": "" }

    pielou:
      plugin: direct_attribute
      params:
        source: plots
        field: pielou
        max_value: 1
      # ex: { "value": 0.5, "max": 1, "units": "" }

    simpson:
      plugin: direct_attribute
      params:
        source: plots
        field: simpson
        max_value: 1
      # ex: { "value": 0.5, "max": 1, "units": "" }

    biomass:
      plugin: direct_attribute
      params:
        source: plots
        field: biomass
        units: "t/ha"
        max_value: 800
      # ex: { "value": 450, "max": 800, "units": "t/ha" }

##################################################################
# 3) CONFIG POUR LES SHAPES
##################################################################
- group_by: shape
  source:
    data: shape_stats
    grouping: shape_ref
    relation:
      plugin: "stats_loader"
      key: "id"

  widgets_data:
    general_info:
      plugin: "transform_chain"
      steps:
        # Extraction de la géométrie du shape
        - plugin: "shape_processor"
          params:
            source: "shape_ref"
            field: "location"
            format: "geojson"
            return_gdf: true
          output_key: "main_shape"

        # Calculer la surface totale (aire de l'emprise)
        - plugin: "vector_overlay"
          params:
            operation: "coverage"
            shape_field: "@main_shape.shape_coords"
            area_unit: "ha"
          output_key: "land_area"

        # Surface forestière
        - plugin: "vector_overlay"
          params:
            operation: "intersection"
            overlay_path: "imports/layers/amap_carto_3k_20240715/amap_carto_3k_20240715.shp"
            shape_field: "@main_shape.shape_coords"
            area_unit: "ha"
          output_key: "forest_area"

        # Intersection avec les zones minières
        - plugin: "vector_overlay"
          params:
            operation: "intersection"
            overlay_path: "imports/shapes/mines.gpkg"
            shape_field: "@main_shape.shape_coords"
            area_unit: "ha"
          output_key: "mining_areas"

        # Calcul de la forêt sur mine
        - plugin: "vector_overlay"
          params:
            operation: "intersection"
            shape_field: "@mining_areas.intersections"
            overlay_path: "imports/layers/amap_carto_3k_20240715/amap_carto_3k_20240715.shp"
            area_unit: "ha"
          output_key: "forest_mining"

        # Intersection avec les réserves
        - plugin: "vector_overlay"
          params:
            operation: "intersection"
            overlay_path: "imports/shapes/protected_areas"
            shape_field: "@main_shape.shape_coords"
            attribute_field: "type"
            where: "type = 'Réserve'"
            area_unit: "ha"
          output_key: "reserve_areas"

        # Calcul de la forêt en réserve
        - plugin: "vector_overlay"
          params:
            operation: "intersection"
            shape_field: "@reserve_areas.intersections"
            overlay_path: "imports/layers/amap_carto_3k_20240715/amap_carto_3k_20240715.shp"
            area_unit: "ha"
          output_key: "forest_reserve"

        # Intersection avec les périmètres de protection des eaux (PPE)
        - plugin: "vector_overlay"
          params:
            operation: "intersection"
            overlay_path: "imports/shapes/ppe"
            shape_field: "@main_shape.shape_coords"
            area_unit: "ha"
          output_key: "ppe_areas"

        # Calcul de la forêt sur PPE
        - plugin: "vector_overlay"
          params:
            operation: "intersection"
            shape_field: "@ppe_areas.intersections"
            overlay_path: "imports/layers/amap_carto_3k_20240715/amap_carto_3k_20240715.shp"
            area_unit: "ha"
          output_key: "forest_ppe"

        # Statistiques d'altitude
        - plugin: "raster_stats"
          params:
            raster_path: "imports/layers/mnt100_epsg3163.tif"
            shape_field: "@main_shape.shape_coords"
            stats: ["min", "max", "median", "mean"]
          output_key: "elevation_stats"

        # Statistiques de pluviométrie
        - plugin: "raster_stats"
          params:
            raster_path: "imports/layers/rainfall_epsg3163.tif"
            shape_field: "@main_shape.shape_coords"
            stats: ["min", "max", "mean"]
          output_key: "rainfall_stats"

        # Extraire land_area_ha
        - plugin: "custom_calculator"
          params:
            operation: "ratio_calculation"
            numerator: "@land_area.coverage_area"
            denominator: 1
            scale_factor: 1
          output_key: "land_area_ha_calc"

        # Extraire forest_area_ha
        - plugin: "custom_calculator"
          params:
            operation: "sum_array_slice"
            array: "@forest_area.intersections"
            start_index: 0
            end_index: 999
            total: "value"
            total_value: 1
          output_key: "forest_area_ha_sum"

        # Extraire forest_mining_ha
        - plugin: "custom_calculator"
          params:
            operation: "sum_array_slice"
            array: "@forest_mining.intersections"
            start_index: 0
            end_index: 999
            total: "value"
            total_value: 1
          output_key: "forest_mining_ha_sum"

        # Extraire forest_reserve_ha
        - plugin: "custom_calculator"
          params:
            operation: "sum_array_slice"
            array: "@forest_reserve.intersections"
            start_index: 0
            end_index: 999
            total: "value"
            total_value: 1
          output_key: "forest_reserve_ha_sum"

        # Extraire forest_ppe_ha
        - plugin: "custom_calculator"
          params:
            operation: "sum_array_slice"
            array: "@forest_ppe.intersections"
            start_index: 0
            end_index: 999
            total: "value"
            total_value: 1
          output_key: "forest_ppe_ha_sum"

        # Construire le résultat final
        - plugin: "custom_calculator"
          params:
            operation: "custom_formula"
            formula: "{'land_area_ha': land_area_ha_calc.value, 'forest_area_ha': forest_area_ha_sum.slice_sum, 'forest_mining_ha': forest_mining_ha_sum.slice_sum, 'forest_reserve_ha': forest_reserve_ha_sum.slice_sum, 'forest_ppe_ha': forest_ppe_ha_sum.slice_sum, 'rainfall': {'min': rainfall_stats.min, 'max': rainfall_stats.max}, 'elevation_median': elevation_stats.median, 'elevation_max': elevation_stats.max}"
            variables:
              land_area_ha_calc: "@land_area_ha_calc"
              forest_area_ha_sum: "@forest_area_ha_sum"
              forest_mining_ha_sum: "@forest_mining_ha_sum"
              forest_reserve_ha_sum: "@forest_reserve_ha_sum"
              forest_ppe_ha_sum: "@forest_ppe_ha_sum"
              rainfall_stats: "@rainfall_stats"
              elevation_stats: "@elevation_stats"
          output_key: "general_info_data"
        # ex:
      # {
      #   "land_area_ha": 941252.41,
      #   "forest_area_ha": 321711.77,
      #   "forest_mining_ha": 21106,
      #   "forest_reserve_ha": 11800,
      #   "forest_ppe_ha": 48275,
      #   "rainfall": {"min": 510, "max": 4820},
      #   "elevation_median": 214,
      #   "elevation_max": 1622
      # }

    geography:
      plugin: shape_processor
      params:
        source: shape_ref
        field: location
        format: "topojson"
        simplify: true
        layers:
          - name: forest_cover
            clip: true
            simplify: true
      # ex:
      # {
      #   "shape_coords": {...},
      #   "forest_cover_coords": {...}
      # }

    forest_cover:
      plugin: class_object_binary_aggregator
      params:
        source: shape_stats
        groups:
          - label: emprise
            field: cover_forest
            classes: ["forest", "non_forest"]
            class_mapping:
              "Forêt": "forest"
              "Hors-forêt": "non_forest"
          - label: um
            field: cover_forestum
            classes: ["forest", "non_forest"]
            class_mapping:
              "Forêt": "forest"
              "Hors-forêt": "non_forest"
          - label: num
            field: cover_forestnum
            classes: ["forest", "non_forest"]
            class_mapping:
              "Forêt": "forest"
              "Hors-forêt": "non_forest"
      # ex:
      # {
      #   "emprise": { "forest": 0.34, "non_forest": 0.66 },
      #   "um": { "forest": 0.23, "non_forest": 0.77 },
      #   "num": { "forest": 0.37, "non_forest": 0.63 }
      # }

    land_use:
      plugin: class_object_categories_extractor
      params:
        source: shape_stats
        class_object: land_use
        categories_order:
          - "NUM"
          - "UM"
          - "Sec"
          - "Humide"
          - "Très Humide"
          - "Réserve"
          - "PPE"
          - "Concessions"
          - "Forêt"
      # ex:
      # {
      #   "categories": ["NUM", "UM", "Sec", "Humide", "Très Humide", "Réserve", "PPE", "Concessions", "Forêt"],
      #   "values": [720516.37, 220736.05, 245865.63, 564601.88, 130784.90, 14272.87, 94334.71, 121703.50, 321711.77]
      # }

    elevation_distribution:
      plugin: class_object_series_ratio_aggregator
      params:
        source: shape_stats
        distributions:
          elevation:
            total: "land_elevation"
            subset: "forest_elevation"
            complement_mode: "difference"  # Mode spécial pour l'élévation
      # ex:
      #
      #"elevation": {
      #   "classes": [0, 200, 400, 600, 800],  # Équivalent à "altitudes"
      #   "subset": [0.1, 0.2, 0.3, 0.2, 0.1],  # Équivalent à "forest"
      #   "complement": [0.1, 0.2, 0.3, 0.2, 0.1]  # Équivalent à "non_forest"
      #}
      #

    holdridge:
      plugin: class_object_categories_mapper
      params:
        source: shape_stats
        categories:
          forest:
            class_object: holdridge_forest
            mapping:
              sec: "Sec"
              humide: "Humide"
              tres_humide: "Très Humide"
          non_forest:
            class_object: holdridge_forest_out
            mapping:
              sec: "Sec"
              humide: "Humide"
              tres_humide: "Très Humide"
      # ex:
      # {
      #   "forest": {
      #     "sec": 0.022,
      #     "humide": 0.223,
      #     "tres_humide": 0.096
      #   },
      #   "non_forest": {
      #     "sec": 0.239,
      #     "humide": 0.376,
      #     "tres_humide": 0.043
      #   }
      # }

    forest_types:
      plugin: class_object_categories_extractor
      params:
        source: shape_stats
        class_object: cover_foresttype
        categories_order:
          - "Forêt coeur"
          - "Forêt mature"
          - "Forêt secondaire"
      # ex:
      # {
      #   "Forêt coeur": 0.064,
      #   "Forêt mature": 0.514,
      #   "Forêt secondaire": 0.422
      # }

    forest_cover_by_elevation:
      plugin: class_object_series_matrix_extractor
      params:
        source: shape_stats
        axis:
          field: "class_name"
          numeric: true
          sort: true
        series:
          - name: "forest_um"
            class_object: "ratio_forest_um_elevation"
            scale: 100
          - name: "forest_num"
            class_object: "ratio_forest_num_elevation"
            scale: 100
          - name: "hors_foret_um"
            class_object: "ratio_forest_um_elevation"
            scale: 100
            complement: true
          - name: "hors_foret_num"
            class_object: "ratio_forest_num_elevation"
            scale: 100
            complement: true
      # ex:
      # {
      #     "class_name": [0, 200, 400, 600, 800],  # Altitudes
      #     "forest_um": [20, 30, 40, 30, 20],      # % forêt UM
      #     "forest_num": [25, 35, 45, 35, 25],     # % forêt NUM
      #     "hors_foret_um": [80, 70, 60, 70, 80],  # % hors-forêt UM
      #     "hors_foret_num": [75, 65, 55, 65, 75]  # % hors-forêt NUM
      # }

    forest_types_by_elevation:
      plugin: class_object_series_by_axis_extractor
      params:
        source: shape_stats
        axis:
          field: "class_name"  # Champ contenant les valeurs d'axe
          output_field: "altitudes"  # Nom du champ d'axe dans la sortie
          numeric: true  # Conversion en numérique
          sort: true  # Tri des valeurs
        types:  # Mapping nom de sortie -> class_object
          secondaire: "forest_secondary_elevation"
          mature: "forest_mature_elevation"
          coeur: "forest_core_elevation"
      # ex:
      # {
      #   "altitudes": [0, 200, 400, 600, 800],
      #   "secondaire": [10, 15, 20, 15, 10],
      #   "mature": [30, 40, 45, 40, 30],
      #   "coeur": [20, 25, 30, 25, 20]
      # }

    fragmentation:
      plugin: class_object_field_aggregator
      params:
        fields:
          - source: shape_stats
            class_object: fragment_meff_cbc
            target: meff
            units: km²
      # ex:
      # {"meff": {"value": 0.122142521265423, "units": "km²"}}

    fragmentation_distribution:
      plugin: class_object_series_extractor
      params:
        source: shape_stats
        class_object: "forest_fragmentation"  # Le class_object à extraire
        size_field:  # Configuration de l'axe x
          input: "class_name"
          output: "sizes"
          numeric: true
          sort: true
        value_field:  # Configuration de l'axe y
          input: "class_value"
          output: "values"
          numeric: true
      # ex:
      # {
      #     "sizes": [10, 20, 30, 40, 50],  # Valeurs triées de class_name
      #     "values": [15, 25, 35, 25, 15]  # Valeurs correspondantes de class_value
      # }
